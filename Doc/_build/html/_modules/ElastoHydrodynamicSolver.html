
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ElastoHydrodynamicSolver &#8212; PyFrac 1.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PyFrac 1.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ElastoHydrodynamicSolver</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file is part of PyFrac.</span>

<span class="sd">Created by Haseeb Zia on Wed Dec 28 14:43:38 2016.</span>
<span class="sd">Copyright (c) &quot;ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE, Switzerland, Geo-Energy Laboratory&quot;, 2016-2019. All rights reserved.</span>
<span class="sd">See the LICENSE.TXT file for more details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">src.FluidModel</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">src.Symmetry</span> <span class="k">import</span> <span class="o">*</span>


<div class="viewcode-block" id="finiteDiff_operator_laminar"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.finiteDiff_operator_laminar">[docs]</a><span class="k">def</span> <span class="nf">finiteDiff_operator_laminar</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">muPrime</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function evaluate the finite difference 5 point stencil matrix, i.e. the A matrix in the ElastoHydrodynamic</span>
<span class="sd">    equations in e.g. Dontsov and Peirce 2008. The matrix is evaluated with the laminar flow assumption.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        w (ndarray-float)              -- the width of the trial fracture.</span>
<span class="sd">        EltCrack (ndarray-int)         -- the list of elements inside the fracture.</span>
<span class="sd">        muPrime (ndarray-float)        -- the scaled local viscosity of the injected fluid (12 * viscosity)</span>
<span class="sd">        Mesh (CartesianMesh object)       the mesh.</span>
<span class="sd">        InCrack (ndarray-int)          -- An array specifying whether elements are inside the fracture or not with</span>
<span class="sd">                                          1 or 0 respectively.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        FinDiffOprtr (ndarray-float)   --  the finite difference matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FinDiffOprtr</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">hx</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">hy</span>

    <span class="c1"># width at the cell edges evaluated by averaging. Zero if the edge is outside fracture</span>
    <span class="n">wLftEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">wRgtEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">wBtmEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">wTopEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>

    <span class="c1"># the finite difference operator matrix</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">wLftEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">wRgtEdge</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                                            <span class="n">wBtmEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">wTopEdge</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wLftEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wRgtEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wBtmEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wTopEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">FinDiffOprtr</span></div>


<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="Gravity_term"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.Gravity_term">[docs]</a><span class="k">def</span> <span class="nf">Gravity_term</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">muPrime</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns the gravity term (G in Zia and Lecampion 2019).</span>
<span class="sd">    Arguments:</span>
<span class="sd">        w (ndarray-float)              -- the width of the trial fracture.</span>
<span class="sd">        EltCrack (ndarray-int)         -- the list of elements inside the fracture.</span>
<span class="sd">        muPrime (ndarray-float)        -- the scaled local viscosity of the injected fluid (12 * viscosity)</span>
<span class="sd">        Mesh (CartesianMesh object)       the mesh.</span>
<span class="sd">        InCrack (ndarray-int)          -- An array specifying whether elements are inside the fracture or not with</span>
<span class="sd">                                          1 or 0 respectively.</span>
<span class="sd">        density (float)                -- the density of the fluid.</span>

<span class="sd">    Returns:</span>
<span class="sd">        G (ndarray-float)              -- the matrix with the gravity terms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># width at the cell edges evaluated by averaging. Zero if the edge is outside fracture</span>
    <span class="n">wBtmEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">wTopEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>

    <span class="n">G</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">density</span> <span class="o">*</span> <span class="mf">9.81</span> <span class="o">*</span> <span class="p">(</span><span class="n">wTopEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">wBtmEdge</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">G</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="FiniteDiff_operator_turbulent_implicit"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.FiniteDiff_operator_turbulent_implicit">[docs]</a><span class="k">def</span> <span class="nf">FiniteDiff_operator_turbulent_implicit</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">vkm1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span> <span class="n">dgrain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function evaluate the finite difference matrix, i.e. the A matrix in the ElastoHydrodynamic equations ( see e.g.</span>
<span class="sd">    Dontsov and Peirce 2008). The matrix is evaluated by taking turbulence into account. The full evolution of friction</span>
<span class="sd">    factor as a function of Reynold&#39;s number and relative roughness is incorporated.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        w (ndarray-float)              -- the width of the trial fracture.</span>
<span class="sd">        EltCrack (ndarray-int)         -- the list of elements inside the fracture</span>
<span class="sd">        mu (ndarray-float)             -- the local viscosity of the injected fluid</span>
<span class="sd">        Mesh (CartesianMesh object)        the mesh</span>
<span class="sd">        InCrack (ndarray-int)          -- an array specifying whether elements are inside the fracture or not with</span>
<span class="sd">                                            1 or 0 respectively</span>
<span class="sd">        vkm1 (ndarray-float)           -- the velocity at cell edges from the previous iteration (if necessary). Here,</span>
<span class="sd">                                            it is used as the starting guess for the implicit solver.</span>
<span class="sd">        C (ndarray-float)              -- the elasticity matrix</span>
<span class="sd">        sigma0 (ndarrray-float)        -- the confining stress</span>
<span class="sd">        dgrain (float)                 -- the grain size. Used to get the relative roughness.</span>
<span class="sd">                </span>
<span class="sd">    Returns:</span>
<span class="sd">        FinDiffOprtr (ndarray-float)   --  the finite difference matrix.</span>
<span class="sd">        vk (ndarray-float)             -- the velocity evaluated for current iteration</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">FinDiffOprtr</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">hx</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">hy</span>

    <span class="c1"># todo: can be evaluated at each cell edge</span>
    <span class="n">rough</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span><span class="o">/</span><span class="n">dgrain</span>
    <span class="n">rough</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rough</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">3.</span>

    <span class="c1"># width on edges; evaluated by averaging the widths of adjacent cells</span>
    <span class="n">wLftEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">wRgtEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">wBtmEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">wTopEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># pressure gradient data structure. The rows store pressure gradient in the following order.</span>
    <span class="c1"># 0 - left edge in x-direction    # 1 - right edge in x-direction</span>
    <span class="c1"># 2 - bottom edge in y-direction  # 3 - top edge in y-direction</span>
    <span class="c1"># 4 - left edge in y-direction    # 5 - right edge in y-direction</span>
    <span class="c1"># 6 - bottom edge in x-direction  # 7 - top edge in x-direction</span>

    <span class="n">dp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="p">(</span><span class="n">dpdxLft</span><span class="p">,</span> <span class="n">dpdxRgt</span><span class="p">,</span> <span class="n">dpdyBtm</span><span class="p">,</span> <span class="n">dpdyTop</span><span class="p">)</span> <span class="o">=</span> <span class="n">pressure_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">)</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpdxLft</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpdxRgt</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpdyBtm</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">dpdyTop</span>
    <span class="c1"># linear interpolation for pressure gradient on the edges where central difference not available</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">])</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">])</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">])</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">]</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">EltCrack</span><span class="p">])</span><span class="o">/</span><span class="mi">4</span>

    <span class="c1"># magnitude of pressure gradient vector on the cell edges. Used to calculate the friction factor</span>
    <span class="n">dpLft</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">dpRgt</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">dpBtm</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">dpTop</span> <span class="o">=</span> <span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

    <span class="n">vk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="c1"># the factor to be multiplied to the velocity from last iteration to get the upper bracket</span>
    <span class="n">upBracket_factor</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># loop to calculate velocity on each cell edge implicitly</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">EltCrack</span><span class="p">)):</span>
        <span class="c1"># todo !!! Hack. zero velocity if the pressure gradient is zero or very small width</span>
        <span class="k">if</span> <span class="n">dpLft</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-8</span> <span class="ow">or</span> <span class="n">wLftEdge</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">wLftEdge</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">rho</span><span class="p">,</span> <span class="n">dpLft</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># check if bracket gives residuals with opposite signs</span>
            <span class="k">if</span> <span class="n">Velocity_Residual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">Velocity_Residual</span><span class="p">(</span>
                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># bracket not valid. finding suitable bracket</span>
                <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">findBracket</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find the root with brentq method.</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dpRgt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-8</span> <span class="ow">or</span> <span class="n">wRgtEdge</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">vk</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">wRgtEdge</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">rho</span><span class="p">,</span> <span class="n">dpRgt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># check if bracket gives residuals with opposite signs</span>
            <span class="k">if</span> <span class="n">Velocity_Residual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">Velocity_Residual</span><span class="p">(</span>
                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># bracket not valid. finding suitable bracket</span>
                <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">findBracket</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find the root with brentq method.</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dpBtm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-8</span> <span class="ow">or</span> <span class="n">wBtmEdge</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">vk</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">wBtmEdge</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">rho</span><span class="p">,</span> <span class="n">dpBtm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># check if bracket gives residuals with opposite signs</span>
            <span class="k">if</span> <span class="n">Velocity_Residual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">Velocity_Residual</span><span class="p">(</span>
                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># bracket not valid. finding suitable bracket</span>
                <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">findBracket</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find the root with brentq method.</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">arg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dpTop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-8</span> <span class="ow">or</span> <span class="n">wTopEdge</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1e-10</span><span class="p">:</span>
            <span class="n">vk</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">wTopEdge</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">rho</span><span class="p">,</span> <span class="n">dpTop</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># check if bracket gives residuals with opposite signs</span>
            <span class="k">if</span> <span class="n">Velocity_Residual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="o">*</span><span class="n">Velocity_Residual</span><span class="p">(</span>
                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># bracket not valid. finding suitable bracket</span>
                <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">findBracket</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find the root with brentq method.</span>
                <span class="n">vk</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">brentq</span><span class="p">(</span><span class="n">Velocity_Residual</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                            <span class="n">upBracket_factor</span> <span class="o">*</span> <span class="n">vkm1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">arg</span><span class="p">)</span>

    <span class="c1"># calculating Reynold&#39;s number with the velocity</span>
    <span class="n">ReLftEdge</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">wLftEdge</span> <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">ReRgtEdge</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">wRgtEdge</span> <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">ReBtmEdge</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">wBtmEdge</span> <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>
    <span class="n">ReTopEdge</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">wTopEdge</span> <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">mu</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span>


    <span class="c1"># non zeros Reynolds numbers</span>
    <span class="n">ReLftEdge_nonZero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ReLftEdge</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ReRgtEdge_nonZero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ReRgtEdge</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ReBtmEdge_nonZero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ReBtmEdge</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ReTopEdge_nonZero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ReTopEdge</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># calculating friction factor with the Yang-Joseph explicit function</span>
    <span class="n">ffLftEdge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ffRgtEdge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ffBtmEdge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ffTopEdge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">ffLftEdge</span><span class="p">[</span><span class="n">ReLftEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">friction_factor_vector</span><span class="p">(</span><span class="n">ReLftEdge</span><span class="p">[</span><span class="n">ReLftEdge_nonZero</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">ReLftEdge_nonZero</span><span class="p">])</span>
    <span class="n">ffRgtEdge</span><span class="p">[</span><span class="n">ReRgtEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">friction_factor_vector</span><span class="p">(</span><span class="n">ReRgtEdge</span><span class="p">[</span><span class="n">ReRgtEdge_nonZero</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">ReRgtEdge_nonZero</span><span class="p">])</span>
    <span class="n">ffBtmEdge</span><span class="p">[</span><span class="n">ReBtmEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">friction_factor_vector</span><span class="p">(</span><span class="n">ReBtmEdge</span><span class="p">[</span><span class="n">ReBtmEdge_nonZero</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">ReBtmEdge_nonZero</span><span class="p">])</span>
    <span class="n">ffTopEdge</span><span class="p">[</span><span class="n">ReTopEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">friction_factor_vector</span><span class="p">(</span><span class="n">ReTopEdge</span><span class="p">[</span><span class="n">ReTopEdge_nonZero</span><span class="p">],</span> <span class="n">rough</span><span class="p">[</span><span class="n">ReTopEdge_nonZero</span><span class="p">])</span>

    <span class="c1"># the conductivity matrix</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cond</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ReLftEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">wLftEdge</span><span class="p">[</span><span class="n">ReLftEdge_nonZero</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">ffLftEdge</span><span class="p">[</span><span class="n">ReLftEdge_nonZero</span><span class="p">]</span>
                                                                     <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">ReLftEdge_nonZero</span><span class="p">]])</span>
    <span class="n">cond</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ReRgtEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">wRgtEdge</span><span class="p">[</span><span class="n">ReRgtEdge_nonZero</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">ffRgtEdge</span><span class="p">[</span><span class="n">ReRgtEdge_nonZero</span><span class="p">]</span>
                                                                     <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">ReRgtEdge_nonZero</span><span class="p">]])</span>
    <span class="n">cond</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ReBtmEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">wBtmEdge</span><span class="p">[</span><span class="n">ReBtmEdge_nonZero</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">ffBtmEdge</span><span class="p">[</span><span class="n">ReBtmEdge_nonZero</span><span class="p">]</span>
                                                                     <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">ReBtmEdge_nonZero</span><span class="p">]])</span>
    <span class="n">cond</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">ReTopEdge_nonZero</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTopEdge</span><span class="p">[</span><span class="n">ReTopEdge_nonZero</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">ffTopEdge</span><span class="p">[</span><span class="n">ReTopEdge_nonZero</span><span class="p">]</span>
                                                                     <span class="o">*</span> <span class="n">vk</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">[</span><span class="n">ReTopEdge_nonZero</span><span class="p">]])</span>


    <span class="c1"># assembling the finite difference matrix</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">cond</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">cond</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cond</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cond</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cond</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cond</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">FinDiffOprtr</span><span class="p">,</span> <span class="n">vk</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="Velocity_Residual"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.Velocity_Residual">[docs]</a><span class="k">def</span> <span class="nf">Velocity_Residual</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gives the residual of the velocity equation. It is used by the root finder.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        v (float):          current velocity guess</span>
<span class="sd">        args (</span>
<span class="sd">            w (float):          width at the given cell edge</span>
<span class="sd">            mu (float):         viscosity at the given cell edge</span>
<span class="sd">            rho (float):        density of the injected fluid</span>
<span class="sd">            dp (float):         pressure gradient at the given cell edge</span>
<span class="sd">            rough (float):      roughness (width / grain size) at the cell center</span>
<span class="sd">             )</span>
<span class="sd">             </span>
<span class="sd">    Returns:</span>
<span class="sd">         float:             residual of the velocity equation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">dp</span><span class="p">,</span> <span class="n">rough</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

    <span class="c1"># Reynolds number</span>
    <span class="n">Re</span> <span class="o">=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">3</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">v</span> <span class="o">/</span> <span class="n">mu</span>

    <span class="c1"># friction factor using MDR approximation</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">friction_factor_MDR</span><span class="p">(</span><span class="n">Re</span><span class="p">,</span> <span class="n">rough</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">v</span><span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="n">dp</span><span class="o">/</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">f</span><span class="p">)</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="findBracket"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.findBracket">[docs]</a><span class="k">def</span> <span class="nf">findBracket</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">guess</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function can be used to find bracket for a root finding algorithm.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        func (callable function): the function giving the residual for which zero is to be found</span>
<span class="sd">        guess (float): starting guess</span>
<span class="sd">        args (tupple): arguments passed to the function</span>

<span class="sd">    Returns:</span>
<span class="sd">         float : the lower bracket</span>
<span class="sd">         float : the higher bracket</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">guess</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">guess</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Res_a</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">Res_b</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">Res_a</span> <span class="o">*</span> <span class="n">Res_b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">b</span>
        <span class="n">Res_b</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s1">&#39;Velocity bracket cannot be found&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="MakeEquationSystem_ViscousFluid"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.MakeEquationSystem_ViscousFluid">[docs]</a><span class="k">def</span> <span class="nf">MakeEquationSystem_ViscousFluid</span><span class="p">(</span><span class="n">solk</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function makes the linearized system of equations to be solved by a linear system solver. The system is</span>
<span class="sd">    assembled with the extended footprint (treating the channel and the extended tip elements distinctly; see</span>
<span class="sd">    description of the ILSA algorithm) as of the last time step. The cells where width constraint is active are solved</span>
<span class="sd">    for traction and pressure seperately.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        sol_k (ndarray-float)               -- the trial change in width and pressure for the current iteration of</span>
<span class="sd">                                               fracture front</span>
<span class="sd">        vkm1 (ndarray-float)                -- the velosity from the last iteration.</span>

<span class="sd">        args (tupple): arguments passed to the function</span>
<span class="sd">            EltChannel (ndarray-int)        -- list of channel elements</span>
<span class="sd">            EltsTipNew (ndarray-int)        -- list of new tip elements. This list also contains the elements that has</span>
<span class="sd">                                               been fully traversed.</span>
<span class="sd">            wLastTS (ndarray-float)         -- fracture width from the last time step</span>
<span class="sd">            wTip (ndarray-float)            -- fracture width in the tip elements</span>
<span class="sd">            EltCrack (ndarray-int)          -- list of elements in the fracture</span>
<span class="sd">            Mesh (CartesianMesh object):    -- the mesh</span>
<span class="sd">            dt (float)                      -- the current time step</span>
<span class="sd">            Q (float)                       -- fluid injection rate at the current time step</span>
<span class="sd">            C (ndarray-float)               -- the elasticity matrix</span>
<span class="sd">            muPrime (ndarray-float)         -- 12 time viscosity of the injected fluid</span>
<span class="sd">            rho (float)                     -- density of the injected fluid</span>
<span class="sd">            InCrack (ndarray-float)         -- an array with one for all the elements in the fracture and zero for rest</span>
<span class="sd">            LeakOff (ndarray-float)         -- the leaked off fluid volume for each cell</span>
<span class="sd">            sigma0 (ndarray-float)          -- the confining stress</span>
<span class="sd">            turb (boolean)                  -- turbulence will be taken into account if true</span>
<span class="sd">            dgrain (float)                  -- the grain size of the rock. it will be used to calculate the fracture</span>
<span class="sd">                                               roughness.</span>
<span class="sd">            active (ndarray-int)            -- index of cells where the width constraint is active.</span>
<span class="sd">            wc (float)                      -- critical minimum width</span>

<span class="sd">    Returns:</span>
<span class="sd">        A (ndarray-float)       -- the A matrix (in the system Ax=b) to be solved by a linear system solver.</span>
<span class="sd">        S (ndarray-float)       -- the b matrix (in the system Ax=b) to be solved by a linear system slover.</span>
<span class="sd">        vk (ndarray-float)      -- the velocity at cell edges.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="p">(</span><span class="n">to_solve</span><span class="p">,</span> <span class="n">to_impose</span><span class="p">,</span> <span class="n">wLastTS</span><span class="p">,</span> <span class="n">imposed_val</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">muPrime</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">,</span> <span class="n">LeakOff</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span>
     <span class="n">turb</span><span class="p">,</span> <span class="n">dgrain</span><span class="p">,</span> <span class="n">gravity</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">wc</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

    <span class="n">wcNplusOne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wLastTS</span><span class="p">)</span>
    <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">+=</span> <span class="n">solk</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)]</span>
    <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">to_impose</span><span class="p">]</span> <span class="o">=</span> <span class="n">imposed_val</span>
    <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">active</span><span class="p">]</span> <span class="o">=</span> <span class="n">wc</span>
    <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wcNplusOne</span> <span class="o">&lt;</span> <span class="n">wc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">wc</span>
    <span class="n">vkm1</span> <span class="o">=</span> <span class="n">interItr</span>

    <span class="k">if</span> <span class="n">turb</span><span class="p">:</span>

        <span class="p">(</span><span class="n">FinDiffOprtr</span><span class="p">,</span> <span class="n">interItr_kp1</span><span class="p">)</span> <span class="o">=</span> <span class="n">FiniteDiff_operator_turbulent_implicit</span><span class="p">(</span><span class="n">wcNplusOne</span><span class="p">,</span>
                                                                    <span class="n">EltCrack</span><span class="p">,</span>
                                                                    <span class="n">muPrime</span> <span class="o">/</span> <span class="mi">12</span><span class="p">,</span>
                                                                    <span class="n">Mesh</span><span class="p">,</span>
                                                                    <span class="n">InCrack</span><span class="p">,</span>
                                                                    <span class="n">rho</span><span class="p">,</span>
                                                                    <span class="n">vkm1</span><span class="p">,</span>
                                                                    <span class="n">C</span><span class="p">,</span>
                                                                    <span class="n">sigma0</span><span class="p">,</span>
                                                                    <span class="n">dgrain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FinDiffOprtr</span> <span class="o">=</span> <span class="n">finiteDiff_operator_laminar</span><span class="p">(</span><span class="n">wcNplusOne</span><span class="p">,</span>
                                                   <span class="n">EltCrack</span><span class="p">,</span>
                                                   <span class="n">muPrime</span><span class="p">,</span>
                                                   <span class="n">Mesh</span><span class="p">,</span>
                                                   <span class="n">InCrack</span><span class="p">)</span>
        <span class="n">interItr_kp1</span> <span class="o">=</span> <span class="n">vkm1</span>

    <span class="k">if</span> <span class="n">gravity</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">Gravity_term</span><span class="p">(</span><span class="n">wcNplusOne</span><span class="p">,</span>
                         <span class="n">EltCrack</span><span class="p">,</span>
                         <span class="n">muPrime</span><span class="p">,</span>
                         <span class="n">Mesh</span><span class="p">,</span>
                         <span class="n">InCrack</span><span class="p">,</span>
                         <span class="n">rho</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,))</span>

    <span class="n">LeakOff_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">LeakOff</span><span class="p">)</span>
    <span class="c1"># LeakOff_cp[active] = (wLastTS[active] - wc) * Mesh.EltArea</span>

    <span class="n">n_ch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)</span>
    <span class="n">n_act</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
    <span class="n">n_tip</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imposed_val</span><span class="p">)</span>
    <span class="n">n_w</span> <span class="o">=</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">n_act</span>
    <span class="n">n_p</span> <span class="o">=</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">n_act</span> <span class="o">+</span> <span class="n">n_tip</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">n_p</span>

    <span class="n">ch_w_row_no</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ch</span><span class="p">)</span>
    <span class="n">act_w_row_no</span> <span class="o">=</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_act</span><span class="p">)</span>
    <span class="n">ch_p_row_no</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ch</span><span class="p">)</span>
    <span class="n">act_p_row_no</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_act</span><span class="p">)</span>
    <span class="n">tip_p_row_no</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">n_act</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_tip</span><span class="p">)</span>

    <span class="n">ch_w_col_no</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ch</span><span class="p">)</span>
    <span class="n">act_tr_col_no</span> <span class="o">=</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_act</span><span class="p">)</span>
    <span class="n">ch_p_col_no</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_ch</span><span class="p">)</span>
    <span class="n">act_p_col_no</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_act</span><span class="p">)</span>
    <span class="n">tip_p_col_no</span> <span class="o">=</span> <span class="n">n_w</span> <span class="o">+</span> <span class="n">n_ch</span> <span class="o">+</span> <span class="n">n_act</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_tip</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_total</span><span class="p">,</span> <span class="n">n_total</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ch_w_row_no</span><span class="p">,</span> <span class="n">ch_w_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">to_solve</span><span class="p">,</span> <span class="n">to_solve</span><span class="p">)]</span>
    <span class="n">A</span><span class="p">[</span><span class="n">ch_w_row_no</span><span class="p">,</span> <span class="n">ch_p_col_no</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>

    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">act_w_row_no</span><span class="p">,</span> <span class="n">ch_w_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">to_solve</span><span class="p">)]</span>
    <span class="n">A</span><span class="p">[</span><span class="n">act_w_row_no</span><span class="p">,</span> <span class="n">act_tr_col_no</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>

    <span class="n">A</span><span class="p">[</span><span class="n">ch_p_row_no</span><span class="p">,</span> <span class="n">ch_w_col_no</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ch_p_row_no</span><span class="p">,</span> <span class="n">ch_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">to_solve</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">to_solve</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ch_p_row_no</span><span class="p">,</span> <span class="n">act_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">to_solve</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">active</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ch_p_row_no</span><span class="p">,</span> <span class="n">tip_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">to_solve</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">to_impose</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">act_p_row_no</span><span class="p">,</span> <span class="n">ch_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">active</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">to_solve</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">act_p_row_no</span><span class="p">,</span> <span class="n">act_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">active</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">active</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">act_p_row_no</span><span class="p">,</span> <span class="n">tip_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">active</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">to_impose</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">tip_p_row_no</span><span class="p">,</span> <span class="n">ch_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">to_impose</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">to_solve</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">tip_p_row_no</span><span class="p">,</span> <span class="n">act_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">to_impose</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">active</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">tip_p_row_no</span><span class="p">,</span> <span class="n">tip_p_col_no</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">to_impose</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">to_impose</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_total</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">S</span><span class="p">[</span><span class="n">ch_w_row_no</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sigma0</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">-</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">to_solve</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">)],</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">])</span> <span class="o">-</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">to_solve</span><span class="p">,</span> <span class="n">to_impose</span><span class="p">)],</span> <span class="n">imposed_val</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">to_impose</span><span class="p">])</span> <span class="o">-</span> \
                        <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">to_solve</span><span class="p">,</span> <span class="n">active</span><span class="p">)],</span> <span class="n">wc</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">active</span><span class="p">])</span>

    <span class="n">S</span><span class="p">[</span><span class="n">act_w_row_no</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sigma0</span><span class="p">[</span><span class="n">active</span><span class="p">]</span> <span class="o">-</span> \
                         <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">)],</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">])</span> <span class="o">-</span> \
                         <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">to_impose</span><span class="p">)],</span> <span class="n">imposed_val</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">to_impose</span><span class="p">])</span> <span class="o">-</span> \
                         <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">active</span><span class="p">)],</span> <span class="n">wc</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">active</span><span class="p">])</span>
                            <span class="c1"># + pfLastTS[to_solve]</span>

    <span class="n">S</span><span class="p">[</span><span class="n">ch_p_row_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Q</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">-</span> <span class="n">LeakOff_cp</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span><span class="c1"># + dt * cond.dot(pfLastTS[EltCrack_R])</span>

    <span class="n">S</span><span class="p">[</span><span class="n">act_p_row_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Q</span><span class="p">[</span><span class="n">active</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">-</span> <span class="n">LeakOff_cp</span><span class="p">[</span><span class="n">active</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">-</span> <span class="p">(</span><span class="n">wc</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">active</span><span class="p">])</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="n">active</span><span class="p">]</span>  <span class="c1"># + dt * cond.dot(pfLastTS[EltCrack_R])</span>

    <span class="n">S</span><span class="p">[</span><span class="n">tip_p_row_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">Q</span><span class="p">[</span><span class="n">to_impose</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">-</span> <span class="n">LeakOff_cp</span><span class="p">[</span><span class="n">to_impose</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">-</span> <span class="p">(</span><span class="n">imposed_val</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">to_impose</span><span class="p">])</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">G</span><span class="p">[</span><span class="n">to_impose</span><span class="p">]</span>  <span class="c1"># + dt * cond.dot(pfLastTS[EltCrack_R])</span>

    <span class="c1"># indices of solved width, pressure and traction in the solution</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch_w_row_no</span><span class="p">)</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ch_p_row_no</span><span class="p">,</span> <span class="n">act_p_row_no</span><span class="p">,</span> <span class="n">tip_p_row_no</span><span class="p">)))</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act_w_row_no</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">interItr_kp1</span><span class="p">,</span> <span class="n">indices</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="MakeEquationSystem_viscousFluid_pressure_substituted"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.MakeEquationSystem_viscousFluid_pressure_substituted">[docs]</a><span class="k">def</span> <span class="nf">MakeEquationSystem_viscousFluid_pressure_substituted</span><span class="p">(</span><span class="n">solk</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function makes the linearized elasto-hydrodynamic system of equations to be solved by a linear system solver.</span>
<span class="sd">    The pressure is back substituted as width using the elasticity relation (see Zia and Lecampion 2019).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        sol_k (ndarray-float)               -- the trial change in width and pressure for the current iteration of</span>
<span class="sd">                                               fracture front</span>
<span class="sd">        interItr (ndarray-float)            -- Any data passed from the last piccard iteration. Initially, it is the</span>
<span class="sd">                                               velocity from the last iteration.</span>

<span class="sd">        args (tupple): arguments passed to the function</span>
<span class="sd">            EltChannel (ndarray-int)        -- list of channel elements</span>
<span class="sd">            EltsTipNew (ndarray-int)        -- list of new tip elements. This list also contains the elements that has</span>
<span class="sd">                                               been fully traversed.</span>
<span class="sd">            wLastTS (ndarray-float)         -- fracture width from the last time step</span>
<span class="sd">            wTip (ndarray-float)            -- fracture width in the tip elements</span>
<span class="sd">            EltCrack (ndarray-int)          -- list of elements in the fracture</span>
<span class="sd">            Mesh (CartesianMesh object):    -- the mesh</span>
<span class="sd">            dt (float)                      -- the current time step</span>
<span class="sd">            Q (float)                       -- fluid injection rate at the current time step</span>
<span class="sd">            C (ndarray-float)               -- the elasticity matrix</span>
<span class="sd">            muPrime (ndarray-float)         -- 12 time viscosity of the injected fluid</span>
<span class="sd">            rho (float)                     -- density of the injected fluid</span>
<span class="sd">            InCrack (ndarray-float)         -- an array with one for all the elements in the fracture and zero for rest</span>
<span class="sd">            LeakOff (ndarray-float)         -- the leaked off fluid volume for each cell</span>
<span class="sd">            sigma0 (ndarray-float)          -- the confining stress</span>
<span class="sd">            turb (boolean)                  -- turbulence will be taken into account if true</span>
<span class="sd">            dgrain (float)                  -- the grain size of the rock. it will be used to calculate the fracture</span>
<span class="sd">                                               roughness.</span>
<span class="sd">            gravity (boolean)               -- flag specifying if the effect of gravity is to be evaluated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A (ndarray-float)               -- the A matrix (in the system Ax=b) to be solved by a linear system solver.</span>
<span class="sd">        S (ndarray-float)               -- the b matrix (in the system Ax=b) to be solved by a linear system slover.</span>
<span class="sd">        interItr_kp1                    -- Any data to be passed to the next iteration. At the moment its the velocity</span>
<span class="sd">                                           at cell edges.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">,</span> <span class="n">wLastTS</span><span class="p">,</span> <span class="n">wTip</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">muPrime</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">,</span> <span class="n">LeakOff</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span>
     <span class="n">turb</span><span class="p">,</span> <span class="n">dgrain</span><span class="p">,</span> <span class="n">gravity</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">wc</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>

    <span class="n">delwK</span> <span class="o">=</span> <span class="n">solk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
    <span class="n">wcNplusOne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wLastTS</span><span class="p">)</span>
    <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">+</span> <span class="n">delwK</span>
    <span class="n">wcNplusOne</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTip</span>

    <span class="k">if</span> <span class="n">turb</span><span class="p">:</span>
        <span class="n">vkm1</span> <span class="o">=</span> <span class="n">interItr</span>
        <span class="p">(</span><span class="n">FinDiffOprtr</span><span class="p">,</span> <span class="n">interItr_kp1</span><span class="p">)</span> <span class="o">=</span> <span class="n">FiniteDiff_operator_turbulent_implicit</span><span class="p">(</span><span class="n">wcNplusOne</span><span class="p">,</span>
                                                                    <span class="n">EltCrack</span><span class="p">,</span>
                                                                    <span class="n">muPrime</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span>
                                                                    <span class="n">Mesh</span><span class="p">,</span>
                                                                    <span class="n">InCrack</span><span class="p">,</span>
                                                                    <span class="n">rho</span><span class="p">,</span>
                                                                    <span class="n">vkm1</span><span class="p">,</span>
                                                                    <span class="n">C</span><span class="p">,</span>
                                                                    <span class="n">sigma0</span><span class="p">,</span>
                                                                    <span class="n">dgrain</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FinDiffOprtr</span> <span class="o">=</span> <span class="n">finiteDiff_operator_laminar</span><span class="p">(</span><span class="n">wcNplusOne</span><span class="p">,</span>
                                                   <span class="n">EltCrack</span><span class="p">,</span>
                                                   <span class="n">muPrime</span><span class="p">,</span>
                                                   <span class="n">Mesh</span><span class="p">,</span>
                                                   <span class="n">InCrack</span><span class="p">)</span>
        <span class="n">interItr_kp1</span> <span class="o">=</span> <span class="n">interItr</span>

    <span class="k">if</span> <span class="n">gravity</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">Gravity_term</span><span class="p">(</span><span class="n">wcNplusOne</span><span class="p">,</span>
                     <span class="n">EltCrack</span><span class="p">,</span>
                     <span class="n">muPrime</span><span class="p">,</span>
                     <span class="n">Mesh</span><span class="p">,</span>
                     <span class="n">InCrack</span><span class="p">,</span>
                     <span class="n">rho</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,</span> <span class="p">))</span>

    <span class="n">condCC</span> <span class="o">=</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">EltChannel</span><span class="p">]</span>
    <span class="n">condCT</span> <span class="o">=</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">EltTip</span><span class="p">]</span>
    <span class="n">condTC</span> <span class="o">=</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltTip</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">EltChannel</span><span class="p">]</span>
    <span class="n">condTT</span> <span class="o">=</span> <span class="n">FinDiffOprtr</span><span class="p">[</span><span class="n">EltTip</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">EltTip</span><span class="p">]</span>

    <span class="n">Channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">Tip</span> <span class="o">=</span> <span class="n">Channel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">Channel</span><span class="p">,</span> <span class="n">Channel</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">Channel</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">condCC</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">)])</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">Channel</span><span class="p">,</span> <span class="n">Tip</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">condCT</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">Tip</span><span class="p">,</span> <span class="n">Channel</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">condTC</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">)])</span>
    <span class="n">A</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">Tip</span><span class="p">,</span> <span class="n">Tip</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">dt</span> <span class="o">*</span> <span class="n">condTT</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">S</span><span class="p">[</span><span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">condCC</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">)],</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">+</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">)],</span> <span class="n">wTip</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma0</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">+</span> \
                            <span class="n">dt</span> <span class="o">*</span> <span class="n">Q</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">-</span> <span class="n">LeakOff</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span><span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">]</span>

    <span class="n">S</span><span class="p">[</span><span class="n">Tip</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">wTip</span> <span class="o">-</span> <span class="n">wLastTS</span><span class="p">[</span><span class="n">EltTip</span><span class="p">])</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">condTC</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">)],</span> \
                                <span class="n">wLastTS</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">)],</span> <span class="n">wTip</span><span class="p">)</span> <span class="o">+</span> \
                                <span class="n">sigma0</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">-</span> <span class="n">LeakOff</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">/</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">EltArea</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">G</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span>

    <span class="c1"># indices of solved width, pressure and traction in the solution</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Channel</span><span class="p">)</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tip</span><span class="p">)</span>
    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">interItr_kp1</span><span class="p">,</span> <span class="n">indices</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="MakeEquationSystem_mechLoading"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.MakeEquationSystem_mechLoading">[docs]</a><span class="k">def</span> <span class="nf">MakeEquationSystem_mechLoading</span><span class="p">(</span><span class="n">wTip</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">EltLoaded</span><span class="p">,</span> <span class="n">w_loaded</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function makes the linear system of equations to be solved by a linear system solver. The system is assembled</span>
<span class="sd">    with the extended footprint (treating the channel and the extended tip elements distinctly). The given width is</span>
<span class="sd">    imposed on the given loaded elements (see Zia and Lecampion 2019)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Ccc</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">)]</span>
    <span class="n">Cct</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">)]</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ccc</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span>
    <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">EltChannel</span> <span class="o">==</span> <span class="n">EltLoaded</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">S</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Cct</span><span class="p">,</span> <span class="n">wTip</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">w_loaded</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="MakeEquationSystem_volumeControl"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.MakeEquationSystem_volumeControl">[docs]</a><span class="k">def</span> <span class="nf">MakeEquationSystem_volumeControl</span><span class="p">(</span><span class="n">w_lst_tmstp</span><span class="p">,</span> <span class="n">wTip</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">,</span> <span class="n">sigma_o</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">ElemArea</span><span class="p">,</span> <span class="n">lkOff</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function makes the linear system of equations to be solved by a linear system solver. The system is assembled</span>
<span class="sd">    with the extended footprint (treating the channel and the extended tip elements distinctly). The the volume of the</span>
<span class="sd">    fracture is imposed to be equal to the fluid injected into the fracture (see Zia and Lecampion 2019).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Ccc</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltChannel</span><span class="p">)]</span>
    <span class="n">Cct</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">)]</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ccc</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span>
    <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">S</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sigma_o</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ccc</span><span class="p">,</span><span class="n">w_lst_tmstp</span><span class="p">[</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Cct</span><span class="p">,</span><span class="n">wTip</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">ElemArea</span> <span class="o">-</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">wTip</span><span class="p">)</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">w_lst_tmstp</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lkOff</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="Elastohydrodynamic_ResidualFun"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.Elastohydrodynamic_ResidualFun">[docs]</a><span class="k">def</span> <span class="nf">Elastohydrodynamic_ResidualFun</span><span class="p">(</span><span class="n">solk</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">interItr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gives the residual of the solution of the current iteration for the viscous fluid, extended footprint</span>
<span class="sd">    case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">vk</span><span class="p">)</span> <span class="o">=</span> <span class="n">MakeEquationSystem_viscousFluid_pressure_substituted</span><span class="p">(</span><span class="n">solk</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">solk</span><span class="p">)</span> <span class="o">-</span> <span class="n">S</span><span class="p">,</span> <span class="n">vk</span><span class="p">)</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="MakeEquationSystem_volumeControl_symmetric"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.MakeEquationSystem_volumeControl_symmetric">[docs]</a><span class="k">def</span> <span class="nf">MakeEquationSystem_volumeControl_symmetric</span><span class="p">(</span><span class="n">w_lst_tmstp</span><span class="p">,</span> <span class="n">wTip_sym</span><span class="p">,</span> <span class="n">EltChannel_sym</span><span class="p">,</span> <span class="n">EltTip_sym</span><span class="p">,</span> <span class="n">C_s</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">sigma_o</span><span class="p">,</span>
                                                          <span class="n">ElemArea</span><span class="p">,</span> <span class="n">LkOff</span><span class="p">,</span> <span class="n">vol_weights</span><span class="p">,</span> <span class="n">sym_elements</span><span class="p">,</span> <span class="n">dwTip</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function makes the linear system of equations to be solved by a linear system solver. The system is assembled</span>
<span class="sd">    with the extended footprint (treating the channel and the extended tip elements distinctly). The the volume of the</span>
<span class="sd">    fracture is imposed to be equal to the fluid injected into the fracture (see Zia and Lecampion 2018).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Ccc</span> <span class="o">=</span> <span class="n">C_s</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel_sym</span><span class="p">,</span> <span class="n">EltChannel_sym</span><span class="p">)]</span>
    <span class="n">Cct</span> <span class="o">=</span> <span class="n">C_s</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltChannel_sym</span><span class="p">,</span> <span class="n">EltTip_sym</span><span class="p">)]</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Ccc</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">EltChannel_sym</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)))</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">vol_weights</span><span class="p">[</span><span class="n">EltChannel_sym</span><span class="p">]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">A</span><span class="p">,</span> <span class="n">weights</span><span class="p">))</span>

    <span class="n">S</span> <span class="o">=</span> <span class="o">-</span> <span class="n">sigma_o</span><span class="p">[</span><span class="n">EltChannel_sym</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ccc</span><span class="p">,</span> <span class="n">w_lst_tmstp</span><span class="p">[</span><span class="n">sym_elements</span><span class="p">[</span><span class="n">EltChannel_sym</span><span class="p">]])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Cct</span><span class="p">,</span> <span class="n">wTip_sym</span><span class="p">)</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">ElemArea</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dwTip</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">LkOff</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="velocity"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.velocity">[docs]</a><span class="k">def</span> <span class="nf">velocity</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">,</span> <span class="n">muPrime</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gives the velocity at the cell edges evaluated using the Poiseuille flow assumption.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">dpdxLft</span><span class="p">,</span> <span class="n">dpdxRgt</span><span class="p">,</span> <span class="n">dpdyBtm</span><span class="p">,</span> <span class="n">dpdyTop</span><span class="p">)</span> <span class="o">=</span> <span class="n">pressure_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">)</span>

    <span class="c1"># velocity at the edges in the following order (x-left edge, x-right edge, y-bottom edge, y-top edge, y-left edge,</span>
    <span class="c1">#                                               y-right edge, x-bottom edge, x-top edge)</span>
    <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">*</span> <span class="n">dpdxLft</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">*</span> <span class="n">dpdxRgt</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">*</span> <span class="n">dpdyBtm</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">*</span> <span class="n">dpdyTop</span>

    <span class="n">vel</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span>
        <span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span>
        <span class="mi">2</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>
    <span class="n">vel</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">])</span> <span class="o">/</span> <span class="mi">4</span>

    <span class="n">vel_magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">vel_magnitude</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">vel_magnitude</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">vel_magnitude</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="n">vel_magnitude</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">vel</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">vel_magnitude</span></div>


<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="pressure_gradient"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.pressure_gradient">[docs]</a><span class="k">def</span> <span class="nf">pressure_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function gives the pressure gradient at the cell edges evaluated with the pressure calculated from the</span>
<span class="sd">    elasticity relation for the given fracture width.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma0</span>

    <span class="n">dpdxLft</span> <span class="o">=</span> <span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">-</span> <span class="n">pf</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">dpdxRgt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pf</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">])</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">dpdyBtm</span> <span class="o">=</span> <span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">-</span> <span class="n">pf</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">dpdyTop</span> <span class="o">=</span> <span class="p">(</span><span class="n">pf</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">-</span> <span class="n">pf</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">])</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">dpdxLft</span><span class="p">,</span> <span class="n">dpdxRgt</span><span class="p">,</span> <span class="n">dpdyBtm</span><span class="p">,</span> <span class="n">dpdyTop</span></div>


<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="calculate_fluid_flow_characteristics_laminar"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.calculate_fluid_flow_characteristics_laminar">[docs]</a><span class="k">def</span> <span class="nf">calculate_fluid_flow_characteristics_laminar</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">,</span> <span class="n">muPrime</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculate fluid flux and velocity at the cell edges evaluated with the pressure calculated from the</span>
<span class="sd">    elasticity relation for the given fracture width and the poisoille&#39;s Law.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dpdxLft</span><span class="p">,</span> <span class="n">dpdxRgt</span><span class="p">,</span> <span class="n">dpdyBtm</span><span class="p">,</span> <span class="n">dpdyTop</span> <span class="o">=</span> <span class="n">pressure_gradient</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">sigma0</span><span class="p">,</span> <span class="n">Mesh</span><span class="p">,</span> <span class="n">EltCrack</span><span class="p">,</span> <span class="n">InCrack</span><span class="p">)</span>

    <span class="c1"># width at the cell edges evaluated by averaging. Zero if the edge is outside fracture</span>
    <span class="n">wLftEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">wRgtEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="n">wBtmEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">wTopEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">InCrack</span><span class="p">[</span><span class="n">Mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>

    <span class="n">fluid_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">wLftEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">dpdxLft</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">,</span> <span class="o">-</span><span class="n">wRgtEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">dpdxRgt</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">))</span>
    <span class="n">fluid_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">fluid_flux</span><span class="p">,</span> <span class="o">-</span><span class="n">wBtmEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">dpdyBtm</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">))</span>
    <span class="n">fluid_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">fluid_flux</span><span class="p">,</span> <span class="o">-</span><span class="n">wTopEdge</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">dpdyTop</span> <span class="o">/</span> <span class="n">muPrime</span><span class="p">))</span>

    <span class="n">fluid_vel</span> <span class="o">=</span> <span class="n">fluid_flux</span>
    <span class="n">fluid_vel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">wLftEdge</span>
    <span class="n">fluid_vel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">wRgtEdge</span>
    <span class="n">fluid_vel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">wBtmEdge</span>
    <span class="n">fluid_vel</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/=</span> <span class="n">wTopEdge</span>

    <span class="n">Rey_number</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">density</span> <span class="o">*</span> <span class="n">fluid_flux</span> <span class="o">/</span> <span class="n">muPrime</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fluid_flux</span><span class="p">,</span> <span class="n">fluid_vel</span><span class="p">,</span> <span class="n">Rey_number</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="Picard_Newton"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.Picard_Newton">[docs]</a><span class="k">def</span> <span class="nf">Picard_Newton</span><span class="p">(</span><span class="n">Res_fun</span><span class="p">,</span> <span class="n">sys_fun</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">TypValue</span><span class="p">,</span> <span class="n">interItr_init</span><span class="p">,</span> <span class="n">Tol</span><span class="p">,</span> <span class="n">maxitr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">relax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">PicardPerNewton</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">perf_node</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixed Picard Newton solver for nonlinear systems.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        Res_fun (function)      -- The function calculating the residual.</span>
<span class="sd">        sys_fun (function)      -- The function giving the system A,b for the Picard solver to solve the linear system</span>
<span class="sd">                                   of the form Ax=b.</span>
<span class="sd">        guess (ndarray)         -- The initial guess.</span>
<span class="sd">        TypValue (ndarray)      -- Typical value of the variable to estimate the Epsilon to calculate Jacobian.</span>
<span class="sd">        interItr (ndarray)      -- Initial value of the variable(s) exchanged between the iterations, if any.</span>
<span class="sd">        relax (float)           -- The relaxation factor.</span>
<span class="sd">        Tol (float)             -- Tolerance.</span>
<span class="sd">        maxitr (int):           -- Maximum number of iterations.</span>
<span class="sd">        args (tuple)            -- arguments given to the residual and systems functions.</span>
<span class="sd">        PicardPerNewton (int)   -- For hybrid Picard/Newton solution. Number of picard iterations for every Newton</span>
<span class="sd">                                   iteration.</span>
<span class="sd">    Returns:</span>
<span class="sd">            solk (ndarray)      -- solution at the end of iteration.</span>
<span class="sd">            interItr            -- any data passed between iterations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">solk</span> <span class="o">=</span> <span class="n">guess</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">normlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interItr</span> <span class="o">=</span> <span class="n">interItr_init</span>
    <span class="n">newton</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="n">Tol</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">maxitr</span><span class="p">:</span>

        <span class="n">solkm1</span> <span class="o">=</span> <span class="n">solk</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">%</span> <span class="n">PicardPerNewton</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">Fx</span><span class="p">,</span> <span class="n">interItr</span><span class="p">)</span> <span class="o">=</span> <span class="n">Res_fun</span><span class="p">(</span><span class="n">solk</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newton</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Jac</span> <span class="o">=</span> <span class="n">Jacobian</span><span class="p">(</span><span class="n">Res_fun</span><span class="p">,</span> <span class="n">solk</span><span class="p">,</span> <span class="n">TypValue</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Jac</span><span class="p">,</span> <span class="o">-</span><span class="n">Fx</span><span class="p">)</span>
            <span class="n">solk</span> <span class="o">=</span> <span class="n">solkm1</span> <span class="o">+</span> <span class="n">dx</span>
            <span class="n">newton</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys_fun</span><span class="p">(</span><span class="n">solk</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="n">solk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relax</span><span class="p">)</span> <span class="o">*</span> <span class="n">solkm1</span> <span class="o">+</span> <span class="n">relax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;singlular matrix!&#39;</span><span class="p">)</span>
                <span class="n">solk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">solk</span><span class="p">),),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">solk</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">norm_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">solk</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">solkm1</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">solkm1</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="n">norm_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">solk</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">solkm1</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">solkm1</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">norm_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">solk</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">-</span> <span class="n">solkm1</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]))</span> <span class="o">/</span> \
                      <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">solkm1</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm_tr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">norm_w</span> <span class="o">+</span> <span class="n">norm_p</span> <span class="o">+</span> <span class="n">norm_tr</span>

        <span class="n">normlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>

        <span class="c1"># todo !!! Hack: Consider coverged if norm grows and last norm is less than 1e-4</span>
        <span class="c1"># if norm &gt; normlist[k - 1] and normlist[k - 1] &lt; 1e-4:</span>
        <span class="c1">#     break</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">maxitr</span><span class="p">:</span>  <span class="c1"># returns nan as solution if does not converge</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Picard iteration not converged after &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">maxitr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; iterations, norm:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>
            <span class="n">solk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">solk</span><span class="p">),),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">solk</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">perf_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perf_node</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">perf_node</span><span class="o">.</span><span class="n">normList</span> <span class="o">=</span> <span class="n">normlist</span>

    <span class="k">return</span> <span class="n">solk</span><span class="p">,</span> <span class="n">interItr</span></div>


<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="Jacobian"><a class="viewcode-back" href="../doc_src/ElastoHydrodynamicSolver.html#ElastoHydrodynamicSolver.Jacobian">[docs]</a><span class="k">def</span> <span class="nf">Jacobian</span><span class="p">(</span><span class="n">Residual_function</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">TypValue</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">central</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interItr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns the Jacobian of the given function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="p">(</span><span class="n">Fx</span><span class="p">,</span> <span class="n">interItr</span><span class="p">)</span> <span class="o">=</span> <span class="n">Residual_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">Jac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">Epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">TypValue</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">xip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Epsilon</span>
        <span class="k">if</span> <span class="n">central</span><span class="p">:</span>
            <span class="n">xin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">xin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Epsilon</span>
            <span class="n">Jac</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Residual_function</span><span class="p">(</span><span class="n">xip</span><span class="p">,</span><span class="n">interItr</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Residual_function</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span><span class="n">interItr</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Epsilon</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">Fxi</span><span class="p">,</span> <span class="n">interItr</span><span class="p">)</span> <span class="o">=</span> <span class="n">Residual_function</span><span class="p">(</span><span class="n">xip</span><span class="p">,</span> <span class="n">interItr</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">Jac</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fxi</span> <span class="o">-</span> <span class="n">Fx</span><span class="p">)</span> <span class="o">/</span> <span class="n">Epsilon</span>

    <span class="k">return</span> <span class="n">Jac</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PyFrac 1.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Haseeb Zia.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>