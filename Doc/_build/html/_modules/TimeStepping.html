
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TimeStepping &#8212; PyFrac 1.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PyFrac 1.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for TimeStepping</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># This file is part of PyFrac.</span>
<span class="c1">#</span>
<span class="c1"># Created by Haseeb Zia on 03.04.17.</span>
<span class="c1"># Copyright (c) ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE, Switzerland, Geo-Energy Laboratory, 2016-2019.  All rights reserved.</span>
<span class="c1"># See the LICENSE.TXT file for more details. </span>
<span class="c1">#</span>


<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># local imports</span>
<span class="kn">from</span> <span class="nn">src.VolIntegral</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.Utility</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.TipInversion</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.ElastoHydrodynamicSolver</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.LevelSet</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.HFAnalyticalSolutions</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src.Properties</span> <span class="k">import</span> <span class="n">IterationProperties</span>
<span class="kn">from</span> <span class="nn">src.anisotropy</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>


<div class="viewcode-block" id="attempt_time_step"><a class="viewcode-back" href="../doc_src/TimeStepping.html#TimeStepping.attempt_time_step">[docs]</a><span class="k">def</span> <span class="nf">attempt_time_step</span><span class="p">(</span><span class="n">Frac</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">mat_properties</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span> <span class="n">sim_properties</span><span class="p">,</span> <span class="n">inj_properties</span><span class="p">,</span>
                      <span class="n">timeStep</span><span class="p">,</span> <span class="n">perfNode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; this function attempts to propagate fracture with the given time step. The function injects fluid into the</span>
<span class="sd">        fracture according to the given front advacning scheme.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        Frac (Fracture object):                       fracture object from the last time step</span>
<span class="sd">        C (ndarray-float):                            the elasticity matrix</span>
<span class="sd">        mat_properties (MaterialProperties object):   material properties</span>
<span class="sd">        fluid_properties (FluidProperties object):    fluid properties</span>
<span class="sd">        sim_properties (SimulationParameters object): simulation parameters</span>
<span class="sd">        inj_properties (InjectionProperties object):  injection properties</span>
<span class="sd">        timeStep (float):                             time step</span>
<span class="sd">    </span>
<span class="sd">    Return:</span>
<span class="sd">        exitstatus (int) -- see documentation for possible values</span>
<span class="sd">        Fr_k (Fracture)  -- fracture after advancing time step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># index of current time in the time series (first row) of the injection rate array</span>
    <span class="n">indxCurTime</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Frac</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="n">inj_properties</span><span class="o">.</span><span class="n">injectionRate</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">CurrentRate</span> <span class="o">=</span> <span class="n">inj_properties</span><span class="o">.</span><span class="n">injectionRate</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">indxCurTime</span><span class="p">]</span>  <span class="c1"># current injection rate</span>

    <span class="n">Qin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Frac</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">Qin</span><span class="p">[</span><span class="n">inj_properties</span><span class="o">.</span><span class="n">source_location</span><span class="p">]</span> <span class="o">=</span> <span class="n">CurrentRate</span> <span class="c1"># current injection over the domain</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">frontAdvancing</span> <span class="o">==</span> <span class="s1">&#39;explicit&#39;</span><span class="p">:</span>

        <span class="c1"># make a new performance collection node to collect data about the explicit time step advancement</span>
        <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_explFront</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;explicit front&quot;</span><span class="p">)</span>
            <span class="n">perfNode_explFront</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perfNode_explFront</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_k</span> <span class="o">=</span> <span class="n">time_step_explicit_front</span><span class="p">(</span><span class="n">Frac</span><span class="p">,</span>
                                                      <span class="n">C</span><span class="p">,</span>
                                                      <span class="n">timeStep</span><span class="p">,</span>
                                                      <span class="n">Qin</span><span class="p">,</span>
                                                      <span class="n">mat_properties</span><span class="p">,</span>
                                                      <span class="n">fluid_properties</span><span class="p">,</span>
                                                      <span class="n">sim_properties</span><span class="p">,</span>
                                                      <span class="n">perfNode_explFront</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perfNode_explFront</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_explFront</span><span class="o">.</span><span class="n">CpuTime_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Fr_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">NumbOfElts</span> <span class="o">=</span> <span class="n">Fr_k</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">normList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">subIterations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perfNode_explFront</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Frac</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">failure_cause</span> <span class="o">=</span> <span class="n">exitstatus</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Fr_k</span><span class="o">.</span><span class="n">time</span>

        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_k</span>

    <span class="k">elif</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">frontAdvancing</span> <span class="o">==</span> <span class="s1">&#39;semi-implicit&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Advancing front with velocity from last time-step...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_explFront</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;explicit front&quot;</span><span class="p">)</span>
            <span class="n">perfNode_explFront</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perfNode_explFront</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_k</span> <span class="o">=</span> <span class="n">time_step_explicit_front</span><span class="p">(</span><span class="n">Frac</span><span class="p">,</span>
                                                    <span class="n">C</span><span class="p">,</span>
                                                    <span class="n">timeStep</span><span class="p">,</span>
                                                    <span class="n">Qin</span><span class="p">,</span>
                                                    <span class="n">mat_properties</span><span class="p">,</span>
                                                    <span class="n">fluid_properties</span><span class="p">,</span>
                                                    <span class="n">sim_properties</span><span class="p">,</span>
                                                    <span class="n">perfNode_explFront</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perfNode_explFront</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_explFront</span><span class="o">.</span><span class="n">CpuTime_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Fr_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">NumbOfElts</span> <span class="o">=</span> <span class="n">Fr_k</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">normList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">subIterations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perfNode_explFront</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Frac</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">failure_cause</span> <span class="o">=</span> <span class="n">exitstatus</span>

        <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">w_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_k</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">frontAdvancing</span> <span class="o">==</span> <span class="s1">&#39;implicit&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving ElastoHydrodynamic equations with same footprint...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_sameFP</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;same footprint injection&quot;</span><span class="p">)</span>
            <span class="n">perfNode_sameFP</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perfNode_sameFP</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># width by injecting the fracture with the same foot print (balloon like inflation)</span>
        <span class="n">exitstatus</span><span class="p">,</span> <span class="n">w_k</span> <span class="o">=</span> <span class="n">injection_same_footprint</span><span class="p">(</span><span class="n">Frac</span><span class="p">,</span>
                                                   <span class="n">C</span><span class="p">,</span>
                                                   <span class="n">timeStep</span><span class="p">,</span>
                                                   <span class="n">Qin</span><span class="p">,</span>
                                                   <span class="n">mat_properties</span><span class="p">,</span>
                                                   <span class="n">fluid_properties</span><span class="p">,</span>
                                                   <span class="n">sim_properties</span><span class="p">,</span>
                                                   <span class="n">perfNode_sameFP</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perfNode_sameFP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_sameFP</span><span class="o">.</span><span class="n">CpuTime_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Frac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">NumbOfElts</span> <span class="o">=</span> <span class="n">Frac</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">normList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">subIterations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perfNode_sameFP</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Frac</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">failure_cause</span> <span class="o">=</span> <span class="n">exitstatus</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provided front advancing type not supported&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># failed</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting Fracture Front loop...&#39;</span><span class="p">)</span>

    <span class="n">norm</span> <span class="o">=</span> <span class="mf">10.</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Fr_k</span> <span class="o">=</span> <span class="n">Frac</span>

    <span class="c1"># Fracture front loop to find the correct front location</span>
    <span class="k">while</span> <span class="n">norm</span> <span class="o">&gt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">tolFractFront</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Iteration &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="n">fill_frac_last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_k</span><span class="o">.</span><span class="n">FillF</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_extendedFP</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;extended footprint injection&quot;</span><span class="p">)</span>
            <span class="n">perfNode_extendedFP</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[],</span> <span class="p">[]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perfNode_extendedFP</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># find the new footprint and solve the elastohydrodynamic equations to to get the new fracture</span>
        <span class="p">(</span><span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_k</span><span class="p">)</span> <span class="o">=</span> <span class="n">injection_extended_footprint</span><span class="p">(</span><span class="n">w_k</span><span class="p">,</span>
                                                          <span class="n">Frac</span><span class="p">,</span>
                                                          <span class="n">C</span><span class="p">,</span>
                                                          <span class="n">timeStep</span><span class="p">,</span>
                                                          <span class="n">Qin</span><span class="p">,</span>
                                                          <span class="n">mat_properties</span><span class="p">,</span>
                                                          <span class="n">fluid_properties</span><span class="p">,</span>
                                                          <span class="n">sim_properties</span><span class="p">,</span>
                                                          <span class="n">perfNode_extendedFP</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># the new fracture width (notably the new width in the ribbon cells).</span>
            <span class="n">w_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_k</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>

            <span class="c1"># norm is evaluated by dividing the difference in the area of the tip cells between two successive iterations</span>
            <span class="c1"># with the number of tip cells.</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">Fr_k</span><span class="o">.</span><span class="n">FillF</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fill_frac_last</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">Fr_k</span><span class="o">.</span><span class="n">FillF</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">perfNode_extendedFP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_extendedFP</span><span class="o">.</span><span class="n">CpuTime_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Fr_k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">NumbOfElts</span> <span class="o">=</span> <span class="n">Fr_k</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">normList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">subIterations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perfNode_extendedFP</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Frac</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">failure_cause</span> <span class="o">=</span> <span class="n">exitstatus</span>

        <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Norm of subsequent filling fraction estimates = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">maxFrontItrs</span><span class="p">:</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">if</span> <span class="n">perfNode_extendedFP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Frac</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">failure_cause</span> <span class="o">=</span> <span class="n">exitstatus</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fracture front converged after &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; iterations with norm = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">perfNode</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">Fr_k</span><span class="o">.</span><span class="n">time</span>

    <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_k</span></div>


<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="injection_same_footprint"><a class="viewcode-back" href="../doc_src/TimeStepping.html#TimeStepping.injection_same_footprint">[docs]</a><span class="k">def</span> <span class="nf">injection_same_footprint</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">mat_properties</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span> <span class="n">sim_properties</span><span class="p">,</span>
                             <span class="n">perfNode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function solves the ElastoHydrodynamic equations to get the fracture width. The fracture footprint is taken</span>
<span class="sd">    to be the same as in the fracture from the last time step.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        Fr_lstTmStp (Fracture object)                      -- fracture object from the last time step</span>
<span class="sd">        C (ndarray-float)                                  -- the elasticity matrix</span>
<span class="sd">        timeStep (float)                                   -- time step</span>
<span class="sd">        Qin (ndarray-float)                                -- current injection rate</span>
<span class="sd">        mat_properties (MaterialProperties object)         -- material properties</span>
<span class="sd">        fluid_properties (FluidProperties object)          -- fluid properties</span>
<span class="sd">        sim_properties (SimulationParameters object)       -- simulation parameters</span>
<span class="sd">        perfNode (IterationProperties)                     -- a performance node to store performance data</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        exitstatus (int)            -- exit status</span>
<span class="sd">        w_k (ndarray-float)         -- width of the fracture after injection with the same footprint</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">LkOff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c1"># Calculate leak-off term for the tip cell</span>
        <span class="n">LkOff</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">*</span> <span class="n">Integral_over_cell</span><span class="p">(</span>
                                                               <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">,</span>
                                                               <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                                               <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
                                                               <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                               <span class="s1">&#39;Lk&#39;</span><span class="p">,</span>
                                                               <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                                               <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                               <span class="n">Vel</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                                                               <span class="n">dt</span><span class="o">=</span><span class="n">timeStep</span><span class="p">,</span>
                                                               <span class="n">arrival_t</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">])</span>

        <span class="c1"># Calculate leak-off term for the channel cell</span>
        <span class="n">t_lst_min_t0</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span>
        <span class="n">t_min_t0</span> <span class="o">=</span> <span class="n">t_lst_min_t0</span> <span class="o">+</span> <span class="n">timeStep</span>

        <span class="n">LkOff</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_min_t0</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">-</span>
                                        <span class="n">t_lst_min_t0</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>

    <span class="c1"># solve for width. All of the fracture cells are solved (no tip values are is imposed)</span>
    <span class="n">empty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">w_k</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">return_data</span> <span class="o">=</span> <span class="n">solve_width_pressure</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                         <span class="n">sim_properties</span><span class="p">,</span>
                                         <span class="n">fluid_properties</span><span class="p">,</span>
                                         <span class="n">mat_properties</span><span class="p">,</span>
                                         <span class="n">empty</span><span class="p">,</span>
                                         <span class="n">empty</span><span class="p">,</span>
                                         <span class="n">C</span><span class="p">,</span>
                                         <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">FillF</span><span class="p">[</span><span class="n">empty</span><span class="p">],</span>
                                         <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span>
                                         <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">InCrack</span><span class="p">,</span>
                                         <span class="n">LkOff</span><span class="p">,</span>
                                         <span class="n">empty</span><span class="p">,</span>
                                         <span class="n">timeStep</span><span class="p">,</span>
                                         <span class="n">Qin</span><span class="p">,</span>
                                         <span class="n">perfNode</span><span class="p">)</span>

    <span class="c1"># check if the solution is valid</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">w_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="n">w_k</span></div>


<span class="c1"># -----------------------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="injection_extended_footprint"><a class="viewcode-back" href="../doc_src/TimeStepping.html#TimeStepping.injection_extended_footprint">[docs]</a><span class="k">def</span> <span class="nf">injection_extended_footprint</span><span class="p">(</span><span class="n">w_k</span><span class="p">,</span> <span class="n">Fr_lstTmStp</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">mat_properties</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span>
                                 <span class="n">sim_properties</span><span class="p">,</span> <span class="n">perfNode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes the fracture width from the last iteration of the fracture front loop, calculates the level set</span>
<span class="sd">    (fracture front position) by inverting the tip asymptote and then solves the ElastoHydrodynamic equations to obtain</span>
<span class="sd">    the new fracture width.</span>
<span class="sd">     </span>
<span class="sd">    Arguments:</span>
<span class="sd">        w_k (ndarray-float);                                fracture width from the last iteration</span>
<span class="sd">        Fr_lstTmStp (Fracture object):                      fracture object from the last time step </span>
<span class="sd">        C (ndarray-float):                                  the elasticity matrix </span>
<span class="sd">        timeStep (float):                                   time step </span>
<span class="sd">        Qin (ndarray-float):                                current injection rate</span>
<span class="sd">        mat_properties (MaterialProperties object):    material properties</span>
<span class="sd">        fluid_properties (FluidProperties object):          fluid properties </span>
<span class="sd">        sim_Parameters (SimulationParameters object):       simulation parameters</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        int:   possible values:</span>
<span class="sd">                                    0       -- not propagated</span>
<span class="sd">                                    1       -- iteration successful</span>
<span class="sd">                                    2       -- evaluated level set is not valid</span>
<span class="sd">                                    3       -- front is not tracked correctly</span>
<span class="sd">                                    4       -- evaluated tip volume is not valid</span>
<span class="sd">                                    5       -- solution of elastohydrodynamic solver is not valid</span>
<span class="sd">                                    6       -- did not converge after max iterations</span>
<span class="sd">                                    7       -- tip inversion not successful</span>
<span class="sd">                                    8       -- Ribbon element not found in the enclosure of a tip cell</span>
<span class="sd">                                    9       -- Filling fraction not correct</span>
<span class="sd">                                    10      -- Toughness iteration did not converge</span>
<span class="sd">                                    11      -- Projection could not be found</span>
<span class="sd">                                    12      -- Reached end of grid</span>

<span class="sd">        Fracture object:            fracture after advancing time step. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">itr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sgndDist_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">)</span>

    <span class="c1"># toughness iteration loop</span>
    <span class="k">while</span> <span class="n">itr</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">maxToughnessItrs</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;ILSA_orig&#39;</span><span class="p">:</span>
                <span class="n">projection_method</span> <span class="o">=</span> <span class="n">projection_from_ribbon</span>
            <span class="k">elif</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;LS_grad&#39;</span><span class="p">:</span>
                <span class="n">projection_method</span> <span class="o">=</span> <span class="n">projection_from_ribbon_LS_gradient</span>
            <span class="k">if</span> <span class="n">itr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># first iteration</span>
                <span class="n">alpha_ribbon_k</span> <span class="o">=</span> <span class="n">projection_method</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                            <span class="n">sgndDist_k</span><span class="p">)</span>
                <span class="n">alpha_ribbon_km1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha_ribbon_k</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">alpha_ribbon_k</span> <span class="o">+</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">projection_method</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                            <span class="n">sgndDist_k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>


        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span><span class="p">:</span>

            <span class="n">Kprime_k</span> <span class="o">=</span> <span class="n">get_toughness_from_cellCenter</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">,</span>
                                                            <span class="n">sgndDist_k</span><span class="p">,</span>
                                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                                                            <span class="n">mat_properties</span><span class="p">,</span>
                                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">32</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Kprime_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kprime_k</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">:</span>
            <span class="n">Eprime_k</span> <span class="o">=</span> <span class="n">TI_plain_strain_modulus</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">,</span>
                                               <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cij</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Eprime_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">13</span>
                <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Eprime_k</span> <span class="o">=</span> <span class="kc">None</span>



        <span class="c1"># Initialization of the signed distance in the ribbon element - by inverting the tip asymptotics</span>
        <span class="n">sgndDist_k</span> <span class="o">=</span> <span class="mf">1e50</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># Initializing the cells with extremely</span>
                                                                        <span class="c1"># large float value. (algorithm requires inf)</span>

        <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">TipAsymInversion</span><span class="p">(</span><span class="n">w_k</span><span class="p">,</span>
                                                               <span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                               <span class="n">mat_properties</span><span class="p">,</span>
                                                               <span class="n">sim_properties</span><span class="p">,</span>
                                                               <span class="n">timeStep</span><span class="p">,</span>
                                                               <span class="n">Kprime_k</span><span class="o">=</span><span class="n">Kprime_k</span><span class="p">,</span>
                                                               <span class="n">Eprime_k</span><span class="o">=</span><span class="n">Eprime_k</span><span class="p">)</span>


        <span class="c1"># if tip inversion returns nan</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Check if the front is receding</span>
        <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">],</span>
                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">])</span>

        <span class="c1"># region expected to have the front after propagation. The signed distance of the cells only in this region will</span>
        <span class="c1"># evaluated with the fast marching method to avoid unnecessary computation cost</span>
        <span class="n">front_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">tmStpPrefactor</span> <span class="o">*</span> <span class="mf">6.66</span> <span class="o">*</span> <span class="p">(</span>
                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># the search region outwards from the front position at last time step</span>
        <span class="n">pstv_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">front_region</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                                                  <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># the search region inwards from the front position at last time step</span>
        <span class="n">ngtv_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">front_region</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># SOLVE EIKONAL eq via Fast Marching Method starting to get the distance from tip for each cell.</span>
        <span class="n">SolveFMM</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                 <span class="n">front_region</span><span class="p">[</span><span class="n">pstv_region</span><span class="p">],</span>
                 <span class="n">front_region</span><span class="p">[</span><span class="n">ngtv_region</span><span class="p">])</span>

        <span class="c1"># do it only once if not anisotropic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span>
                <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">explicitProjection</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha_ribbon_k</span> <span class="o">-</span> <span class="n">alpha_ribbon_km1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">toleranceProjection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;projection iteration converged after &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">itr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; iterations; exiting norm &quot;</span> <span class="o">+</span>
                      <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>
            <span class="k">break</span>

        <span class="n">alpha_ribbon_km1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iterating on projection... norm &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>
        <span class="n">itr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># if itr == sim_properties.maxToughnessItrs:</span>
    <span class="c1">#     exitstatus = 10</span>
    <span class="c1">#     return exitstatus, None</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveRegime</span><span class="p">:</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="n">find_regime</span><span class="p">(</span><span class="n">w_k</span><span class="p">,</span> <span class="n">Fr_lstTmStp</span><span class="p">,</span> <span class="n">mat_properties</span><span class="p">,</span> <span class="n">sim_properties</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">Kprime_k</span><span class="p">,</span>
                             <span class="o">-</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">])</span>

    <span class="c1"># gets the new tip elements, along with the length and angle of the perpendiculars drawn on front (also containing</span>
    <span class="c1"># the elements which are fully filled after the front is moved outward)</span>
    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;ILSA_orig&#39;</span><span class="p">:</span>
        <span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">l_k</span><span class="p">,</span> <span class="n">alpha_k</span><span class="p">,</span> <span class="n">CellStatus</span> <span class="o">=</span> <span class="n">reconstruct_front</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;LS_grad&#39;</span><span class="p">:</span>
        <span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">l_k</span><span class="p">,</span> <span class="n">alpha_k</span><span class="p">,</span> <span class="n">CellStatus</span> <span class="o">=</span> <span class="n">reconstruct_front_LS_gradient</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">front_region</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;The tip elements are not in the band. Increase the size of the band for FMM to evaluate&quot;</span>
                         <span class="s2">&quot; level set.&quot;</span><span class="p">)</span>

    <span class="c1"># If the angle and length of the perpendicular are not correct</span>
    <span class="n">nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">l_k</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">nan</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">alpha_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">alpha_k</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># check if any of the tip cells has a neighbor outside the grid, i.e. fracture has reached the end of the grid.</span>
    <span class="n">tipNeighb</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tipNeighb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">EltsTipNew</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>


    <span class="c1"># generate the InCrack array for the current front position</span>
    <span class="n">InCrack_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="n">InCrack_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">InCrack_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># the velocity of the front for the current front position</span>
    <span class="c1"># todo: not accurate on the first iteration. needed to be checked</span>
    <span class="n">Vel_k</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span> <span class="o">/</span> <span class="n">timeStep</span>

    <span class="c1"># Calculate filling fraction of the tip cells for the current fracture position</span>
    <span class="n">FillFrac_k</span> <span class="o">=</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                <span class="n">alpha_k</span><span class="p">,</span>
                                <span class="n">l_k</span><span class="p">,</span>
                                <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>

    <span class="c1"># todo !!! Hack: This check rounds the filling fraction to 1 if it is not bigger than 1 + 1e-4 (up to 4 figures)</span>
    <span class="n">FillFrac_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">FillFrac_k</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># if filling fraction is below zero or above 1+1e-6</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># todo: some of the list are redundant to calculate on each iteration</span>
    <span class="c1"># Evaluate the element lists for the trial fracture front</span>
    <span class="p">(</span><span class="n">EltChannel_k</span><span class="p">,</span>
     <span class="n">EltTip_k</span><span class="p">,</span>
     <span class="n">EltCrack_k</span><span class="p">,</span>
     <span class="n">EltRibbon_k</span><span class="p">,</span>
     <span class="n">zrVertx_k</span><span class="p">,</span>
     <span class="n">CellStatus_k</span><span class="p">)</span> <span class="o">=</span> <span class="n">UpdateLists</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                 <span class="n">EltsTipNew</span><span class="p">,</span>
                                 <span class="n">FillFrac_k</span><span class="p">,</span>
                                 <span class="n">sgndDist_k</span><span class="p">,</span>
                                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

    <span class="c1"># EletsTipNew may contain fully filled elements also. Identifying only the partially filled elements</span>
    <span class="n">partlyFilledTip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">EltTip_k</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving the EHL system with the new trial footprint&#39;</span><span class="p">)</span>

    <span class="c1"># Calculating Carter&#39;s coefficient at tip to be used to calculate the volume integral in the tip cells</span>
    <span class="n">zrVrtx_newTip</span> <span class="o">=</span> <span class="n">find_zero_vertex</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">sgndDist_k</span><span class="p">,</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="c1"># finding ribbon cells corresponding to tip cells</span>
    <span class="n">corr_ribbon</span> <span class="o">=</span> <span class="n">find_corresponding_ribbon_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                                 <span class="n">alpha_k</span><span class="p">,</span>
                                                 <span class="n">zrVrtx_newTip</span><span class="p">,</span>
                                                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">Cprime_tip</span> <span class="o">=</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">corr_ribbon</span><span class="p">]</span>

    <span class="c1"># Calculating toughness at tip to be used to calculate the volume integral in the tip cells</span>
    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span><span class="p">:</span>
        <span class="n">zrVrtx_newTip</span> <span class="o">=</span> <span class="n">find_zero_vertex</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">sgndDist_k</span><span class="p">,</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="c1"># get toughness from tip in case of anisotropic or</span>
        <span class="n">Kprime_tip</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">get_toughness_from_zeroVertex</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                           <span class="n">mat_properties</span><span class="p">,</span>
                                                                           <span class="n">alpha_k</span><span class="p">,</span>
                                                                           <span class="n">l_k</span><span class="p">,</span>
                                                                           <span class="n">zrVrtx_newTip</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Kprime_tip</span> <span class="o">=</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Kprime</span><span class="p">[</span><span class="n">corr_ribbon</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">:</span>
        <span class="n">Eprime_tip</span> <span class="o">=</span> <span class="n">TI_plain_strain_modulus</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">,</span>
                                             <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cij</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Eprime_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">EltsTipNew</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Eprime</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">perfNode_wTip</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;tip volume&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perfNode_wTip</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># stagnant tip cells i.e. the tip cells whose distance from front has not changed.</span>
    <span class="n">stagnant</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1e-5</span>
    <span class="k">if</span> <span class="n">stagnant</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_tipAsymptote</span><span class="p">()</span> <span class="ow">is</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stagnant front is only supported with universal tip asymptote. continuing...&quot;</span><span class="p">)</span>
        <span class="n">stagnant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">EltsTipNew</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stagnant</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="c1"># if any tip cell with stagnant front calculate stress intensity factor for stagnant cells</span>
        <span class="n">KIPrime</span> <span class="o">=</span> <span class="n">StressIntensityFactor</span><span class="p">(</span><span class="n">w_k</span><span class="p">,</span>
                                        <span class="n">sgndDist_k</span><span class="p">,</span>
                                        <span class="n">EltsTipNew</span><span class="p">,</span>
                                        <span class="n">EltRibbon_k</span><span class="p">,</span>
                                        <span class="n">stagnant</span><span class="p">,</span>
                                        <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                        <span class="n">Eprime</span><span class="o">=</span><span class="n">Eprime_tip</span><span class="p">)</span>

        <span class="c1"># todo: Find the right cause of failure</span>
        <span class="c1"># if the stress Intensity factor cannot be found. The most common reason is wiggles in the front resulting</span>
        <span class="c1"># in isolated tip cells.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">KIPrime</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Calculate average width in the tip cells by integrating tip asymptote. Width of stagnant cells are calculated</span>
        <span class="c1"># using the stress intensity factor (see Dontsov and Peirce, JFM RAPIDS, 2017)</span>

        <span class="n">wTip</span> <span class="o">=</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                              <span class="n">alpha_k</span><span class="p">,</span>
                              <span class="n">l_k</span><span class="p">,</span>
                              <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                              <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_tipAsymptote</span><span class="p">(),</span>
                              <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                              <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                              <span class="n">fluid_prop</span><span class="o">=</span><span class="n">fluid_properties</span><span class="p">,</span>
                              <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                              <span class="n">stagnant</span><span class="o">=</span><span class="n">stagnant</span><span class="p">,</span>
                              <span class="n">KIPrime</span><span class="o">=</span><span class="n">KIPrime</span><span class="p">,</span>
                              <span class="n">Eprime</span><span class="o">=</span><span class="n">Eprime_tip</span><span class="p">,</span>
                              <span class="n">Cprime</span><span class="o">=</span><span class="n">Cprime_tip</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Calculate average width in the tip cells by integrating tip asymptote</span>
        <span class="n">wTip</span> <span class="o">=</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                              <span class="n">alpha_k</span><span class="p">,</span>
                              <span class="n">l_k</span><span class="p">,</span>
                              <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                              <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_tipAsymptote</span><span class="p">(),</span>
                              <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                              <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                              <span class="n">fluid_prop</span><span class="o">=</span><span class="n">fluid_properties</span><span class="p">,</span>
                              <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                              <span class="n">Kprime</span><span class="o">=</span><span class="n">Kprime_tip</span><span class="p">,</span>
                              <span class="n">Eprime</span><span class="o">=</span><span class="n">Eprime_tip</span><span class="p">,</span>
                              <span class="n">Cprime</span><span class="o">=</span><span class="n">Cprime_tip</span><span class="p">,</span>
                              <span class="n">stagnant</span><span class="o">=</span><span class="n">stagnant</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>

    <span class="c1"># check if the tip volume has gone into negative</span>
    <span class="n">smallNgtvWTip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">wTip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wTip</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wTip</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">smallNgtvWTip</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#                    warnings.warn(&quot;Small negative volume integral(s) received, ignoring &quot;+repr(wTip[smallngtvwTip])+&#39; ...&#39;)</span>
        <span class="n">wTip</span><span class="p">[</span><span class="n">smallNgtvWTip</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wTip</span><span class="p">[</span><span class="n">smallNgtvWTip</span><span class="p">])</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">wTip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">wTip</span><span class="p">)</span><span class="o">==</span><span class="mf">0.</span><span class="p">:</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>


    <span class="n">LkOff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Calculate leak-off term for the tip cell</span>
        <span class="n">LkOff</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">*</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                                                    <span class="n">alpha_k</span><span class="p">,</span>
                                                                    <span class="n">l_k</span><span class="p">,</span>
                                                                    <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                    <span class="s1">&#39;Lk&#39;</span><span class="p">,</span>
                                                                    <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                                                    <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                                    <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                                                                    <span class="n">dt</span><span class="o">=</span><span class="n">timeStep</span><span class="p">,</span>
                                                                    <span class="n">arrival_t</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#todo: no need to evaluate on each iteration. Need to decide. Evaluating here for now for better readability</span>
        <span class="n">LkOff</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span>
                        <span class="n">timeStep</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span>
                        <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>

    <span class="n">w_n_plus1</span><span class="p">,</span> <span class="n">pf_n_plus1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">solve_width_pressure</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                        <span class="n">sim_properties</span><span class="p">,</span>
                                                        <span class="n">fluid_properties</span><span class="p">,</span>
                                                        <span class="n">mat_properties</span><span class="p">,</span>
                                                        <span class="n">EltsTipNew</span><span class="p">,</span>
                                                        <span class="n">partlyFilledTip</span><span class="p">,</span>
                                                        <span class="n">C</span><span class="p">,</span>
                                                        <span class="n">FillFrac_k</span><span class="p">,</span>
                                                        <span class="n">EltCrack_k</span><span class="p">,</span>
                                                        <span class="n">InCrack_k</span><span class="p">,</span>
                                                        <span class="n">LkOff</span><span class="p">,</span>
                                                        <span class="n">wTip</span><span class="p">,</span>
                                                        <span class="n">timeStep</span><span class="p">,</span>
                                                        <span class="n">Qin</span><span class="p">,</span>
                                                        <span class="n">perfNode</span><span class="p">)</span>

    <span class="c1"># check if the new width is valid</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_n_plus1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Picard iteration did not converged. Trying to solve pressure and width seperately...&quot;</span><span class="p">)</span>
        <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">fluidVel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># setting arrival time for fully traversed tip elements (new channel elements)</span>
    <span class="n">Tarrival_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">)</span>
    <span class="n">new_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">FillFrac_k</span><span class="o">&gt;</span><span class="mf">0.9999</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t_enter</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span> <span class="o">-</span> <span class="n">l_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vel_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span>
    <span class="n">max_l</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">])</span> <span class="o">+</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">])</span>
    <span class="n">t_leave</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_l</span><span class="p">)</span> <span class="o">/</span> <span class="n">Vel_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span>
    <span class="n">Tarrival_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_enter</span> <span class="o">+</span> <span class="n">t_leave</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># the fracture to be returned for k plus 1 iteration</span>
    <span class="n">Fr_kplus1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">)</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">time</span> <span class="o">+=</span> <span class="n">timeStep</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w_n_plus1</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">pFluid</span> <span class="o">=</span> <span class="n">pf_n_plus1</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">pNet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,))</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">pNet</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf_n_plus1</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">FillF</span> <span class="o">=</span> <span class="n">FillFrac_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span> <span class="o">=</span> <span class="n">EltChannel_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span> <span class="o">=</span> <span class="n">EltTip_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span> <span class="o">=</span> <span class="n">EltCrack_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltRibbon</span> <span class="o">=</span> <span class="n">EltRibbon_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">ZeroVertex</span> <span class="o">=</span> <span class="n">zrVertx_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">sgndDist</span> <span class="o">=</span> <span class="n">sgndDist_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">l_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">Vel_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">sgndDist_last</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">timeStep_last</span> <span class="o">=</span> <span class="n">timeStep</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">InCrack</span> <span class="o">=</span> <span class="n">InCrack_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">process_fracture_front</span><span class="p">()</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">FractureVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span><span class="p">)</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">Tarrival</span> <span class="o">=</span> <span class="n">Tarrival_k</span>
    <span class="n">new_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">[</span><span class="n">new_tip</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">new_tip</span><span class="p">]</span> <span class="o">/</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">new_tip</span><span class="p">]</span>

    <span class="c1"># setting leak off</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">LkOff_vol</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">LkOff_vol</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">*</span> <span class="n">Integral_over_cell</span><span class="p">(</span>
                                                                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">,</span>
                                                                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                                                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
                                                                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                <span class="s1">&#39;Lk&#39;</span><span class="p">,</span>
                                                                <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                                                <span class="n">frac</span><span class="o">=</span><span class="n">Fr_kplus1</span><span class="p">,</span>
                                                                <span class="n">Vel</span><span class="o">=</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
                                                                <span class="n">dt</span><span class="o">=</span><span class="mf">1.e20</span><span class="p">,</span>
                                                                <span class="n">arrival_t</span><span class="o">=</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">])</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">injectedVol</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Qin</span><span class="p">)</span> <span class="o">*</span> <span class="n">timeStep</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">injectedVol</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">LkOff_vol</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]))</span>\
                           <span class="o">/</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">injectedVol</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveRegime</span><span class="p">:</span>
        <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">regime</span> <span class="o">=</span> <span class="n">regime</span>

    <span class="k">if</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">turbulence</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span><span class="p">:</span>
            <span class="n">ReNumb</span><span class="p">,</span> <span class="n">check</span> <span class="o">=</span> <span class="n">turbulence_check_tip</span><span class="p">(</span><span class="n">fluidVel</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span> <span class="n">return_ReyNumb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span><span class="p">:</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">ReynoldsNumber</span> <span class="o">=</span> <span class="n">ReNumb</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span><span class="p">:</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidFlux</span> <span class="o">=</span> <span class="n">ReNumb</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">viscosity</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidVel</span><span class="p">:</span>
            <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidVelocity</span> <span class="o">=</span> <span class="n">fluidVel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidVel</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span><span class="p">:</span>
            <span class="n">fluid_flux</span><span class="p">,</span> <span class="n">fluid_vel</span><span class="p">,</span> <span class="n">Rey_num</span> <span class="o">=</span> <span class="n">calculate_fluid_flow_characteristics_laminar</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                              <span class="n">C</span><span class="p">,</span>
                                                              <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">,</span>
                                                              <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                              <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span>
                                                              <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">InCrack</span><span class="p">,</span>
                                                              <span class="n">fluid_properties</span><span class="o">.</span><span class="n">muPrime</span><span class="p">,</span>
                                                              <span class="n">fluid_properties</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span><span class="p">:</span>
                <span class="n">fflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">fflux</span><span class="p">[:,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluid_flux</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidFlux</span> <span class="o">=</span> <span class="n">fflux</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidVel</span><span class="p">:</span>
                <span class="n">fvel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">fvel</span><span class="p">[:,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluid_vel</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidVelocity</span> <span class="o">=</span> <span class="n">fvel</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span><span class="p">:</span>
                <span class="n">Rnum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">Rnum</span><span class="p">[:,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rey_num</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">ReynoldsNumber</span> <span class="o">=</span> <span class="n">Rnum</span>

    <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_kplus1</span></div>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------------</span>

<div class="viewcode-block" id="solve_width_pressure"><a class="viewcode-back" href="../doc_src/TimeStepping.html#TimeStepping.solve_width_pressure">[docs]</a><span class="k">def</span> <span class="nf">solve_width_pressure</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">,</span> <span class="n">sim_properties</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span> <span class="n">mat_properties</span><span class="p">,</span> <span class="n">EltTip</span><span class="p">,</span> <span class="n">partlyFilledTip</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span>
                         <span class="n">FillFrac_k</span><span class="p">,</span> <span class="n">EltCrack_k</span><span class="p">,</span> <span class="n">InCrack_k</span><span class="p">,</span> <span class="n">LkOff</span><span class="p">,</span> <span class="n">wTip</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">perfNode</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_volumeControl</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">PerfNode_linSolve</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;Linear solve iterations&quot;</span><span class="p">)</span>
                <span class="n">PerfNode_linSolve</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PerfNode_linSolve</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">EltChannel_sym</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">corresponding</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;Symmetric fracture needs symmetric mesh. Set symmetric flag to True</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;while initializing the mesh&quot;</span><span class="p">)</span>

            <span class="n">EltChannel_sym</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">corresponding</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span>
            <span class="n">EltChannel_sym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">EltChannel_sym</span><span class="p">)</span>

            <span class="n">EltTip_sym</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">corresponding</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span>
            <span class="n">EltTip_sym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">EltTip_sym</span><span class="p">)</span>

            <span class="n">FillF_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,</span> <span class="p">),</span> <span class="p">)</span>
            <span class="n">FillF_mesh</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">FillFrac_k</span>
            <span class="n">FillF_sym</span> <span class="o">=</span> <span class="n">FillF_mesh</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">activeSymtrc</span><span class="p">[</span><span class="n">EltTip_sym</span><span class="p">]]</span>
            <span class="n">partlyFilledTip_sym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">FillF_sym</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">C_EltTip</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltTip_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">],</span>
                                <span class="n">EltTip_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">])]</span>  <span class="c1"># keeping the tip element entries to restore current</span>

            <span class="c1"># filling fraction correction for element in the tip region</span>
            <span class="n">FillF</span> <span class="o">=</span> <span class="n">FillF_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partlyFilledTip_sym</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">FillF</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">-</span> <span class="o">.</span><span class="mi">25</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">ac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
                <span class="n">self_infl</span> <span class="o">=</span> <span class="n">self_influence</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Eprime</span><span class="p">)</span>
                <span class="n">C</span><span class="p">[</span><span class="n">EltTip_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">[</span><span class="n">e</span><span class="p">]],</span> <span class="n">EltTip_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">[</span><span class="n">e</span><span class="p">]]]</span> <span class="o">+=</span> \
                                                                    <span class="n">ac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">self_infl</span>

            <span class="n">wTip_sym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">EltTip_sym</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">wTip_sym_elts</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">activeSymtrc</span><span class="p">[</span><span class="n">EltTip_sym</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">EltTip_sym</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">EltTip</span> <span class="o">==</span> <span class="n">wTip_sym_elts</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">other_corr</span> <span class="o">=</span> <span class="n">get_symetric_elements</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="p">[</span><span class="n">wTip_sym_elts</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">in_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">EltTip</span> <span class="o">==</span> <span class="n">other_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_tip</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">wTip_sym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTip</span><span class="p">[</span><span class="n">in_tip</span><span class="p">]</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wTip_sym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTip</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">EltTip</span> <span class="o">==</span> <span class="n">wTip_sym_elts</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">dwTip</span> <span class="o">=</span> <span class="n">wTip</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">MakeEquationSystem_volumeControl_symmetric</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                           <span class="n">wTip_sym</span><span class="p">,</span>
                                                           <span class="n">EltChannel_sym</span><span class="p">,</span>
                                                           <span class="n">EltTip_sym</span><span class="p">,</span>
                                                           <span class="n">C</span><span class="p">,</span>
                                                           <span class="n">timeStep</span><span class="p">,</span>
                                                           <span class="n">Qin</span><span class="p">,</span>
                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span><span class="p">,</span>
                                                           <span class="n">LkOff</span><span class="p">,</span>
                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">volWeights</span><span class="p">,</span>
                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">activeSymtrc</span><span class="p">,</span>
                                                           <span class="n">dwTip</span><span class="p">)</span>

            <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltTip_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">],</span>  <span class="n">EltTip_sym</span><span class="p">[</span><span class="n">partlyFilledTip_sym</span><span class="p">])]</span> <span class="o">=</span> <span class="n">C_EltTip</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C_EltTip</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltTip</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">],</span>
                                <span class="n">EltTip</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">])]</span>  <span class="c1"># keeping the tip element entries to restore current</span>
            <span class="c1">#  tip correction. This is done to avoid copying the full elasticity matrix.</span>

            <span class="c1"># filling fraction correction for element in the tip region</span>
            <span class="n">FillF</span> <span class="o">=</span> <span class="n">FillFrac_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">partlyFilledTip</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">FillF</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">-</span> <span class="o">.</span><span class="mi">25</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">ac</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span>
                <span class="n">C</span><span class="p">[</span><span class="n">EltTip</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">[</span><span class="n">e</span><span class="p">]],</span> <span class="n">EltTip</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">[</span><span class="n">e</span><span class="p">]]]</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">ac</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">PerfNode_linSolve</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;Linear solve iterations&quot;</span><span class="p">)</span>
                <span class="n">PerfNode_linSolve</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PerfNode_linSolve</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">A</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">MakeEquationSystem_volumeControl</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                           <span class="n">wTip</span><span class="p">,</span>
                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                           <span class="n">EltTip</span><span class="p">,</span>
                                                           <span class="n">C</span><span class="p">,</span>
                                                           <span class="n">timeStep</span><span class="p">,</span>
                                                           <span class="n">Qin</span><span class="p">,</span>
                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span><span class="p">,</span>
                                                           <span class="n">LkOff</span><span class="p">)</span>

            <span class="c1"># regain original C (without filling fraction correction)</span>
            <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltTip</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">],</span> <span class="n">EltTip</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">])]</span> <span class="o">=</span> <span class="n">C_EltTip</span>

        <span class="n">sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">PerfNode_linSolve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">PerfNode_linSolve</span><span class="o">.</span><span class="n">CpuTime_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">subIterations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PerfNode_linSolve</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">symmetric</span><span class="p">:</span>
            <span class="n">del_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">del_w</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">symmetricElts</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">activeSymtrc</span><span class="p">[</span><span class="n">EltChannel_sym</span><span class="p">[</span><span class="n">i</span><span class="p">]]]]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">w</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">+=</span> <span class="n">del_w</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wTip_sym_elts</span><span class="p">)):</span>
                <span class="n">w</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">symmetricElts</span><span class="p">[</span><span class="n">wTip_sym_elts</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">wTip_sym</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">w</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sol</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
            <span class="n">w</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTip</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">p</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">return_data</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([]))</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">return_data</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_viscousInjection</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">guess</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> <span class="o">=</span> <span class="n">timeStep</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Qin</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span> \
                                                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
            <span class="n">guess</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> <span class="o">=</span> <span class="n">timeStep</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Qin</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span> \
                                                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="c1"># velocity at the cell edges evaluated with the guess width. Used as guess</span>
        <span class="c1"># values for the implicit velocity solver.</span>
        <span class="n">vk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">turbulence</span><span class="p">:</span>
            <span class="n">wguess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">wguess</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="n">wguess</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">+</span> <span class="n">guess</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
            <span class="n">wguess</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTip</span>

            <span class="n">vk</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">(</span><span class="n">wguess</span><span class="p">,</span>
                          <span class="n">EltCrack_k</span><span class="p">,</span>
                          <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                          <span class="n">InCrack_k</span><span class="p">,</span>
                          <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">muPrime</span><span class="p">,</span>
                          <span class="n">C</span><span class="p">,</span>
                          <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">)</span>

        <span class="c1"># typical value for pressure</span>
        <span class="n">typValue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span>
        <span class="n">typValue</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e5</span>

        <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">perfNode_Picard</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;Picard iteration&quot;</span><span class="p">)</span>
            <span class="n">perfNode_Picard</span><span class="o">.</span><span class="n">subIterations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perfNode_Picard</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">non_neg</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Making and sloving the system of equations. The width constraint is checked. If active, system is remade with</span>
        <span class="c1"># the oonstraint imposed and is resolved.</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">non_neg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">to_solve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span> <span class="n">neg</span><span class="p">)</span>
            <span class="n">to_impose</span> <span class="o">=</span> <span class="n">EltTip</span>
            <span class="n">imposed_val</span> <span class="o">=</span> <span class="n">wTip</span>

            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">to_solve</span><span class="p">,</span>
                <span class="n">to_impose</span><span class="p">,</span>
                <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                <span class="n">imposed_val</span><span class="p">,</span>
                <span class="n">EltCrack_k</span><span class="p">,</span>
                <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                <span class="n">timeStep</span><span class="p">,</span>
                <span class="n">Qin</span><span class="p">,</span>
                <span class="n">C</span><span class="p">,</span>
                <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">muPrime</span><span class="p">,</span>
                <span class="n">fluid_properties</span><span class="o">.</span><span class="n">density</span><span class="p">,</span>
                <span class="n">InCrack_k</span><span class="p">,</span>
                <span class="n">LkOff</span><span class="p">,</span>
                <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">,</span>
                <span class="n">fluid_properties</span><span class="o">.</span><span class="n">turbulence</span><span class="p">,</span>
                <span class="n">mat_properties</span><span class="o">.</span><span class="n">grainSize</span><span class="p">,</span>
                <span class="n">sim_properties</span><span class="o">.</span><span class="n">gravity</span><span class="p">,</span>
                <span class="n">neg</span><span class="p">,</span>
                <span class="n">mat_properties</span><span class="o">.</span><span class="n">wc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span><span class="p">:</span>
                <span class="n">sys_fun</span> <span class="o">=</span> <span class="n">MakeEquationSystem_viscousFluid_pressure_substituted</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys_fun</span> <span class="o">=</span> <span class="n">MakeEquationSystem_ViscousFluid</span>

            <span class="n">sol</span><span class="p">,</span> <span class="n">v_k</span> <span class="o">=</span> <span class="n">Picard_Newton</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">sys_fun</span><span class="p">,</span>
                                   <span class="n">guess</span><span class="p">,</span>
                                   <span class="n">typValue</span><span class="p">,</span>
                                   <span class="n">vk</span><span class="p">,</span>
                                   <span class="n">sim_properties</span><span class="o">.</span><span class="n">toleranceEHL</span><span class="p">,</span>
                                   <span class="n">sim_properties</span><span class="o">.</span><span class="n">maxSolverItrs</span><span class="p">,</span>
                                   <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
                                   <span class="n">perf_node</span><span class="o">=</span><span class="n">perfNode_Picard</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">w</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sol</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)]</span>
            <span class="n">w</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">wTip</span>
            <span class="n">w</span><span class="p">[</span><span class="n">neg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">wc</span>

            <span class="n">neg_km1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">neg</span><span class="p">)</span>
            <span class="n">new_neg</span> <span class="o">=</span> <span class="n">to_solve</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">wc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">new_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">new_neg</span><span class="p">,</span> <span class="n">neg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_neg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">non_neg</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">frontAdvancing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;implicit&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Width is getting extremely small. Starting again without substituting pressure with&#39;</span>
                          <span class="s1">&#39; width...&#39;</span><span class="p">)</span>
                    <span class="n">sim_properties</span><span class="o">.</span><span class="n">frontAdvancing</span> <span class="o">=</span> <span class="s1">&#39;implicit&#39;</span>
                    <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># changing length of guess</span>
                <span class="n">guess</span> <span class="o">=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">EltTip</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">guess</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> <span class="o">=</span> <span class="n">timeStep</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Qin</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltCrack</span><span class="o">.</span><span class="n">size</span> \
                                                                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>
                <span class="n">neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">neg</span><span class="p">,</span> <span class="n">new_neg</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Width has gone down to negative value. Imposing constraint on width...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">perfNode_Picard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">perfNode_Picard</span><span class="o">.</span><span class="n">CpuTime_end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">perfNode</span><span class="o">.</span><span class="n">subIterations</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perfNode_Picard</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span><span class="p">:</span>
            <span class="c1"># pressure evaluated by dot product of width and elasticity matrix</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">EltCrack_k</span><span class="p">,</span> <span class="n">EltCrack_k</span><span class="p">)],</span> <span class="n">w</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">])</span> <span class="o">+</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span>
            <span class="n">p</span><span class="p">[</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_km1</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
            <span class="n">p</span><span class="p">[</span><span class="n">to_solve</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">n_w</span><span class="p">:</span><span class="n">n_w</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)]</span>
            <span class="n">p</span><span class="p">[</span><span class="n">neg_km1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">n_w</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">):</span><span class="n">n_w</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_km1</span><span class="p">)]</span>
            <span class="n">p</span><span class="p">[</span><span class="n">to_impose</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">n_w</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_km1</span><span class="p">):</span> <span class="n">n_w</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_solve</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_km1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_impose</span><span class="p">)]</span>

        <span class="n">return_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">vk</span><span class="p">,</span> <span class="n">neg_km1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">return_data</span></div>


<div class="viewcode-block" id="turbulence_check_tip"><a class="viewcode-back" href="../doc_src/TimeStepping.html#TimeStepping.turbulence_check_tip">[docs]</a><span class="k">def</span> <span class="nf">turbulence_check_tip</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="n">Fr</span><span class="p">,</span> <span class="n">fluid</span><span class="p">,</span> <span class="n">return_ReyNumb</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calculate the Reynolds number at the cell edges and check if any to the edge between the ribbon cells</span>
<span class="sd">    and the tip cells are turbulent (i.e. the Reynolds number is greater than 2100).</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        vel (ndarray-float):                    the array giving velocity of each edge of the cells in domain </span>
<span class="sd">        Fr (Fracture object):                   the fracture object to be checked</span>
<span class="sd">        fluid (FluidProperties object):         fluid properties object </span>
<span class="sd">        return_ReyNumb (boolean, default False): if true, Reynolds number at all cell edges will be returned </span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        ndarray-float:      Reynolds number of all the cells in the domain; row-wise in the following order : 0--left,</span>
<span class="sd">                            1--right, 2--bottom, 3--top</span>
<span class="sd">        boolean             true if any of the edge between the ribbon and tip cells is turbulent (i.e. Reynolds number</span>
<span class="sd">                            is more than 2100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># width at the adges by averaging</span>
    <span class="n">wLftEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">wRgtEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">wBtmEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">wTopEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">Re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">Re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wLftEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>
    <span class="n">Re</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wRgtEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>
    <span class="n">Re</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wBtmEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>
    <span class="n">Re</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wTopEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>

    <span class="n">ReNum_Ribbon</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># adding Reynolds number of the edges between the ribbon and tip cells to a list</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1"># if the current neighbor (j) of the ribbon cells is in the tip elements list</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltTip</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">ReNum_Ribbon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ReNum_Ribbon</span><span class="p">,</span> <span class="n">Re</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">return_ReyNumb</span><span class="p">:</span>
        <span class="n">wLftEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">wRgtEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">wBtmEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">wTopEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">+</span> <span class="n">Fr</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">Re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">Re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wLftEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>
        <span class="n">Re</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wRgtEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>
        <span class="n">Re</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wBtmEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>
        <span class="n">Re</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">fluid</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">wTopEdge</span> <span class="o">*</span> <span class="n">vel</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">Fr</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">/</span> <span class="n">fluid</span><span class="o">.</span><span class="n">viscosity</span>

        <span class="k">return</span> <span class="n">Re</span><span class="p">,</span> <span class="p">(</span><span class="n">ReNum_Ribbon</span> <span class="o">&gt;</span> <span class="mf">2100.</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ReNum_Ribbon</span> <span class="o">&gt;</span> <span class="mf">2100.</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span></div>


<div class="viewcode-block" id="time_step_explicit_front"><a class="viewcode-back" href="../doc_src/TimeStepping.html#TimeStepping.time_step_explicit_front">[docs]</a><span class="k">def</span> <span class="nf">time_step_explicit_front</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">Qin</span><span class="p">,</span> <span class="n">mat_properties</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span> <span class="n">sim_properties</span><span class="p">,</span>
                             <span class="n">perfNode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes the fracture width from the last iteration of the fracture front loop, calculates the level set</span>
<span class="sd">    (fracture front position) by inverting the tip asymptote and then solves the ElastoHydrodynamic equations to obtain</span>
<span class="sd">    the new fracture width.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        w_k (ndarray-float);                                fracture width from the last iteration</span>
<span class="sd">        Fr_lstTmStp (Fracture object):                      fracture object from the last time step</span>
<span class="sd">        C (ndarray-float):                                  the elasticity matrix</span>
<span class="sd">        timeStep (float):                                   time step</span>
<span class="sd">        Qin (ndarray-float):                                current injection rate</span>
<span class="sd">        mat_properties (MaterialProperties object):    material properties</span>
<span class="sd">        fluid_properties (FluidProperties object):          fluid properties</span>
<span class="sd">        sim_Parameters (SimulationParameters object):       simulation parameters</span>

<span class="sd">    Returns:</span>
<span class="sd">        int:   possible values:</span>
<span class="sd">                                    0       -- not propagated</span>
<span class="sd">                                    1       -- iteration successful</span>
<span class="sd">                                    2       -- evaluated level set is not valid</span>
<span class="sd">                                    3       -- front is not tracked correctly</span>
<span class="sd">                                    4       -- evaluated tip volume is not valid</span>
<span class="sd">                                    5       -- solution of elastohydrodynamic solver is not valid</span>
<span class="sd">                                    6       -- did not converge after max iterations</span>
<span class="sd">                                    7       -- tip inversion not successful</span>
<span class="sd">                                    8       -- Ribbon element not found in the enclosure of a tip cell</span>
<span class="sd">                                    9       -- Filling fraction not correct</span>
<span class="sd">                                    10      -- Toughness iteration did not converge</span>
<span class="sd">                                    11      -- Projection could not be found</span>
<span class="sd">                                    12      -- Reached end of grid</span>
<span class="sd">                                    13      -- Leak off can&#39;t be evaluated</span>

<span class="sd">        Fracture object:            fracture after advancing time step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sgndDist_k</span> <span class="o">=</span> <span class="mf">1e50</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># Initializing the cells with maximum</span>
    <span class="c1"># float value. (algorithm requires inf)</span>
    <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># for cells inside the fracture</span>

    <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">timeStep</span> <span class="o">*</span>
                                                                                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

    <span class="n">front_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">tmStpPrefactor</span> <span class="o">*</span> <span class="mf">6.66</span> <span class="o">*</span><span class="p">(</span>
                <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># the search region outwards from the front position at last time step</span>
    <span class="n">pstv_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">front_region</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                                                   <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># the search region inwards from the front position at last time step</span>
    <span class="n">ngtv_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">front_region</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># SOLVE EIKONAL eq via Fast Marching Method starting to get the distance from tip for each cell.</span>
    <span class="n">SolveFMM</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
             <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltTip</span><span class="p">,</span>
             <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span>
             <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
             <span class="n">front_region</span><span class="p">[</span><span class="n">pstv_region</span><span class="p">],</span>
             <span class="n">front_region</span><span class="p">[</span><span class="n">ngtv_region</span><span class="p">])</span>

    <span class="c1"># gets the new tip elements, along with the length and angle of the perpendiculars drawn on front (also containing</span>
    <span class="c1"># the elements which are fully filled after the front is moved outward)</span>
    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;ILSA_orig&#39;</span><span class="p">:</span>
        <span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">l_k</span><span class="p">,</span> <span class="n">alpha_k</span><span class="p">,</span> <span class="n">CellStatus</span> <span class="o">=</span> <span class="n">reconstruct_front</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;LS_grad&#39;</span><span class="p">:</span>
        <span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">l_k</span><span class="p">,</span> <span class="n">alpha_k</span><span class="p">,</span> <span class="n">CellStatus</span> <span class="o">=</span> <span class="n">reconstruct_front_LS_gradient</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">front_region</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;The tip elements are not in the band. Increase the size of the band for FMM to evaluate&quot;</span>
                         <span class="s2">&quot; level set.&quot;</span><span class="p">)</span>

    <span class="c1"># If the angle and length of the perpendicular are not correct</span>
    <span class="n">nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">l_k</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">nan</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">alpha_k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">alpha_k</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># check if any of the tip cells has a neighbor outside the grid, i.e. fracture has reached the end of the grid.</span>
    <span class="n">tipNeighb</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NeiElements</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tipNeighb</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">EltsTipNew</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># generate the InCrack array for the current front position</span>
    <span class="n">InCrack_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    <span class="n">InCrack_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">InCrack_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Calculate filling fraction of the tip cells for the current fracture position</span>
    <span class="n">FillFrac_k</span> <span class="o">=</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                    <span class="n">alpha_k</span><span class="p">,</span>
                                    <span class="n">l_k</span><span class="p">,</span>
                                    <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                    <span class="s1">&#39;A&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>

    <span class="c1"># todo !!! Hack: This check rounds the filling fraction to 1 if it is not bigger than 1 + 1e-4 (up to 4 figures)</span>
    <span class="n">FillFrac_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">FillFrac_k</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-4</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># if filling fraction is below zero or above 1+1e-6</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="c1"># todo: some of the list are redundant to calculate on each iteration</span>
    <span class="c1"># Evaluate the element lists for the trial fracture front</span>
    <span class="p">(</span><span class="n">EltChannel_k</span><span class="p">,</span>
     <span class="n">EltTip_k</span><span class="p">,</span>
     <span class="n">EltCrack_k</span><span class="p">,</span>
     <span class="n">EltRibbon_k</span><span class="p">,</span>
     <span class="n">zrVertx_k</span><span class="p">,</span>
     <span class="n">CellStatus_k</span><span class="p">)</span> <span class="o">=</span> <span class="n">UpdateLists</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                 <span class="n">EltsTipNew</span><span class="p">,</span>
                                 <span class="n">FillFrac_k</span><span class="p">,</span>
                                 <span class="n">sgndDist_k</span><span class="p">,</span>
                                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>

    <span class="c1"># EletsTipNew may contain fully filled elements also. Identifying only the partially filled elements</span>
    <span class="n">partlyFilledTip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">EltTip_k</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Solving the EHL system with the new trial footprint&#39;</span><span class="p">)</span>

    <span class="c1"># Calculating Carter&#39;s coefficient at tip to be used to calculate the volume integral in the tip cells</span>
    <span class="n">zrVrtx_newTip</span> <span class="o">=</span> <span class="n">find_zero_vertex</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span> <span class="n">sgndDist_k</span><span class="p">,</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="c1"># finding ribbon cells corresponding to tip cells</span>
    <span class="n">corr_ribbon</span> <span class="o">=</span> <span class="n">find_corresponding_ribbon_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                                 <span class="n">alpha_k</span><span class="p">,</span>
                                                 <span class="n">zrVrtx_newTip</span><span class="p">,</span>
                                                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">Cprime_tip</span> <span class="o">=</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">corr_ribbon</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span><span class="p">:</span>
        <span class="n">Kprime_tip</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">get_toughness_from_zeroVertex</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                                                           <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                           <span class="n">mat_properties</span><span class="p">,</span>
                                                                           <span class="n">alpha_k</span><span class="p">,</span>
                                                                           <span class="n">l_k</span><span class="p">,</span>
                                                                           <span class="n">zrVrtx_newTip</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Kprime_tip</span> <span class="o">=</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Kprime</span><span class="p">[</span><span class="n">corr_ribbon</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">:</span>
        <span class="n">Eprime_tip</span> <span class="o">=</span> <span class="n">TI_plain_strain_modulus</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">,</span>
                                             <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cij</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Eprime_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">EltsTipNew</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Eprime</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># the velocity of the front for the current front position</span>
    <span class="c1"># todo: not accurate on the first iteration. needed to be checked</span>
    <span class="n">Vel_k</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span> <span class="o">/</span> <span class="n">timeStep</span>

    <span class="c1"># create a performance node for the root finding to get tip volume</span>
    <span class="k">if</span> <span class="n">perfNode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">perfNode</span><span class="o">.</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">perfNode_wTip</span> <span class="o">=</span> <span class="n">IterationProperties</span><span class="p">(</span><span class="n">itr_type</span><span class="o">=</span><span class="s2">&quot;tip volume&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perfNode_wTip</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># stagnant tip cells i.e. the tip cells whose distance from front has not changed.</span>
    <span class="n">stagnant</span> <span class="o">=</span> <span class="n">Vel_k</span> <span class="o">&lt;</span> <span class="mf">1e-14</span>
    <span class="k">if</span> <span class="n">stagnant</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_tipAsymptote</span><span class="p">()</span> <span class="ow">is</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stagnant front is only supported with universal tip asymptote. Continuing...&quot;</span><span class="p">)</span>
        <span class="n">stagnant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">EltsTipNew</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stagnant</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="c1"># if any tip cell with stagnant front calculate stress intensity factor for stagnant cells</span>
        <span class="n">KIPrime</span> <span class="o">=</span> <span class="n">StressIntensityFactor</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                        <span class="n">sgndDist_k</span><span class="p">,</span>
                                        <span class="n">EltsTipNew</span><span class="p">,</span>
                                        <span class="n">EltRibbon_k</span><span class="p">,</span>
                                        <span class="n">stagnant</span><span class="p">,</span>
                                        <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                        <span class="n">Eprime_tip</span><span class="p">)</span>

        <span class="c1"># todo: Find the right cause of failure</span>
        <span class="c1"># if the stress Intensity factor cannot be found. The most common reason is wiggles in the front resulting</span>
        <span class="c1"># in isolated tip cells.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">KIPrime</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Calculate average width in the tip cells by integrating tip asymptote. Width of stagnant cells are calculated</span>
        <span class="c1"># using the stress intensity factor (see Dontsov and Peirce, JFM RAPIDS, 2017)</span>

        <span class="n">wTip</span> <span class="o">=</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                  <span class="n">alpha_k</span><span class="p">,</span>
                                  <span class="n">l_k</span><span class="p">,</span>
                                  <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                  <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_tipAsymptote</span><span class="p">(),</span>
                                  <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                  <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                  <span class="n">fluid_prop</span><span class="o">=</span><span class="n">fluid_properties</span><span class="p">,</span>
                                  <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                                  <span class="n">stagnant</span><span class="o">=</span><span class="n">stagnant</span><span class="p">,</span>
                                  <span class="n">KIPrime</span><span class="o">=</span><span class="n">KIPrime</span><span class="p">,</span>
                                  <span class="n">Eprime</span><span class="o">=</span><span class="n">Eprime_tip</span><span class="p">,</span>
                                  <span class="n">Cprime</span><span class="o">=</span><span class="n">Cprime_tip</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Calculate average width in the tip cells by integrating tip asymptote</span>
        <span class="n">wTip</span> <span class="o">=</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                  <span class="n">alpha_k</span><span class="p">,</span>
                                  <span class="n">l_k</span><span class="p">,</span>
                                  <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                  <span class="n">sim_properties</span><span class="o">.</span><span class="n">get_tipAsymptote</span><span class="p">(),</span>
                                  <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                  <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                  <span class="n">fluid_prop</span><span class="o">=</span><span class="n">fluid_properties</span><span class="p">,</span>
                                  <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                                  <span class="n">Kprime</span><span class="o">=</span><span class="n">Kprime_tip</span><span class="p">,</span>
                                  <span class="n">Eprime</span><span class="o">=</span><span class="n">Eprime_tip</span><span class="p">,</span>
                                  <span class="n">Cprime</span><span class="o">=</span><span class="n">Cprime_tip</span><span class="p">,</span>
                                  <span class="n">stagnant</span><span class="o">=</span><span class="n">stagnant</span><span class="p">)</span> <span class="o">/</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>

    <span class="c1"># check if the tip volume has gone into negative</span>
    <span class="n">smallNgtvWTip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">wTip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wTip</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wTip</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">smallNgtvWTip</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">wTip</span><span class="p">[</span><span class="n">smallNgtvWTip</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">wTip</span><span class="p">[</span><span class="n">smallNgtvWTip</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wTip</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">wTip</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">LkOff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Calculate leak-off term for the tip cell</span>
        <span class="n">LkOff</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">]</span> <span class="o">*</span> <span class="n">Integral_over_cell</span><span class="p">(</span><span class="n">EltsTipNew</span><span class="p">,</span>
                                                                    <span class="n">alpha_k</span><span class="p">,</span>
                                                                    <span class="n">l_k</span><span class="p">,</span>
                                                                    <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                    <span class="s1">&#39;Lk&#39;</span><span class="p">,</span>
                                                                    <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                                                    <span class="n">frac</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                                    <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                                                                    <span class="n">dt</span><span class="o">=</span><span class="n">timeStep</span><span class="p">,</span>
                                                                    <span class="n">arrival_t</span><span class="o">=</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LkOff</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">13</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t_since_arrival</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span>
        <span class="n">LkOff</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">t_since_arrival</span>
                                            <span class="o">+</span> <span class="n">timeStep</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">t_since_arrival</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LkOff</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">13</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">w_n_plus1</span><span class="p">,</span> <span class="n">pf_n_plus1</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">solve_width_pressure</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                      <span class="n">sim_properties</span><span class="p">,</span>
                                                      <span class="n">fluid_properties</span><span class="p">,</span>
                                                      <span class="n">mat_properties</span><span class="p">,</span>
                                                      <span class="n">EltsTipNew</span><span class="p">,</span>
                                                      <span class="n">partlyFilledTip</span><span class="p">,</span>
                                                      <span class="n">C</span><span class="p">,</span>
                                                      <span class="n">FillFrac_k</span><span class="p">,</span>
                                                      <span class="n">EltCrack_k</span><span class="p">,</span>
                                                      <span class="n">InCrack_k</span><span class="p">,</span>
                                                      <span class="n">LkOff</span><span class="p">,</span>
                                                      <span class="n">wTip</span><span class="p">,</span>
                                                      <span class="n">timeStep</span><span class="p">,</span>
                                                      <span class="n">Qin</span><span class="p">,</span>
                                                      <span class="n">perfNode</span><span class="p">)</span>

    <span class="c1"># check if the new width is valid</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_n_plus1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Picard iteration did not converged. Pressure and width will be solved separately in next attempt...&quot;</span><span class="p">)</span>
        <span class="n">sim_properties</span><span class="o">.</span><span class="n">substitutePressure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">fluidVel</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># setting arrival time for fully traversed tip elements (new channel elements)</span>
    <span class="n">Tarrival_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">)</span>
    <span class="n">new_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">FillFrac_k</span> <span class="o">&gt;</span> <span class="mf">0.9999</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">t_enter</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span> <span class="o">-</span> <span class="n">l_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span> <span class="o">/</span> <span class="n">Vel_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span>
    <span class="n">max_l</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">])</span> <span class="o">+</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">])</span>
    <span class="n">t_leave</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">time</span> <span class="o">+</span> <span class="n">timeStep</span> <span class="o">-</span> <span class="p">(</span><span class="n">l_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_l</span><span class="p">)</span> <span class="o">/</span> <span class="n">Vel_k</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]</span>
    <span class="n">Tarrival_k</span><span class="p">[</span><span class="n">EltsTipNew</span><span class="p">[</span><span class="n">new_channel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_enter</span> <span class="o">+</span> <span class="n">t_leave</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># the fracture to be returned for k plus 1 iteration</span>
    <span class="n">Fr_kplus1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="p">)</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w_n_plus1</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">pFluid</span> <span class="o">=</span> <span class="n">pf_n_plus1</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">pNet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,))</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">pNet</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf_n_plus1</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span> <span class="o">-</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">[</span><span class="n">EltCrack_k</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">time</span> <span class="o">+=</span> <span class="n">timeStep</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">FillF</span> <span class="o">=</span> <span class="n">FillFrac_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span> <span class="o">=</span> <span class="n">EltChannel_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span> <span class="o">=</span> <span class="n">EltTip_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span> <span class="o">=</span> <span class="n">EltCrack_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltRibbon</span> <span class="o">=</span> <span class="n">EltRibbon_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">ZeroVertex</span> <span class="o">=</span> <span class="n">zrVertx_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">l_k</span><span class="p">[</span><span class="n">partlyFilledTip</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">InCrack</span> <span class="o">=</span> <span class="n">InCrack_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">process_fracture_front</span><span class="p">()</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">FractureVolume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span><span class="p">)</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">Tarrival</span> <span class="o">=</span> <span class="n">Tarrival_k</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solved...</span><span class="se">\n</span><span class="s2">Finding velocity of front...&quot;</span><span class="p">)</span>

    <span class="n">itr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># toughness iteration loop</span>
    <span class="k">while</span> <span class="n">itr</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">maxToughnessItrs</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;ILSA_orig&#39;</span><span class="p">:</span>
                <span class="n">projection_method</span> <span class="o">=</span> <span class="n">projection_from_ribbon</span>
            <span class="k">elif</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">projMethod</span> <span class="ow">is</span> <span class="s1">&#39;LS_grad&#39;</span><span class="p">:</span>
                <span class="n">projection_method</span> <span class="o">=</span> <span class="n">projection_from_ribbon_LS_gradient</span>

            <span class="k">if</span> <span class="n">itr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># first iteration</span>
                <span class="n">alpha_ribbon_k</span> <span class="o">=</span> <span class="n">projection_method</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                                                        <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                        <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                        <span class="n">sgndDist_k</span><span class="p">)</span>
                <span class="n">alpha_ribbon_km1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alpha_ribbon_k</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">alpha_ribbon_k</span> <span class="o">+</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">projection_method</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                                                                             <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                                                                             <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                             <span class="n">sgndDist_k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span><span class="p">:</span>

            <span class="n">Kprime_k</span> <span class="o">=</span> <span class="n">get_toughness_from_cellCenter</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">,</span>
                                                     <span class="n">sgndDist_k</span><span class="p">,</span>
                                                     <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                                                     <span class="n">mat_properties</span><span class="p">,</span>
                                                     <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">32</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Kprime_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">11</span>
                <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kprime_k</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">:</span>
            <span class="n">Eprime_k</span> <span class="o">=</span> <span class="n">TI_plain_strain_modulus</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">,</span>
                                               <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cij</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Eprime_k</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">13</span>
                <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Eprime_k</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Initialization of the signed distance in the ribbon element - by inverting the tip asymptotics</span>
        <span class="n">sgndDist_k</span> <span class="o">=</span> <span class="mf">1e50</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,),</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># Initializing the cells with extremely</span>
        <span class="c1"># large float value. (algorithm requires inf)</span>

        <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">TipAsymInversion</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                               <span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                               <span class="n">mat_properties</span><span class="p">,</span>
                                                               <span class="n">sim_properties</span><span class="p">,</span>
                                                               <span class="n">timeStep</span><span class="p">,</span>
                                                               <span class="n">Kprime_k</span><span class="o">=</span><span class="n">Kprime_k</span><span class="p">,</span>
                                                               <span class="n">Eprime_k</span><span class="o">=</span><span class="n">Eprime_k</span><span class="p">)</span>

        <span class="c1"># if tip inversion returns nan</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Check if the front is receding</span>
        <span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">],</span>
                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">])</span>

        <span class="c1"># region expected to have the front after propagation. The signed distance of the cells only in this region will</span>
        <span class="c1"># evaluated with the fast marching method to avoid unnecessary computation cost</span>
        <span class="n">front_region</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">tmStpPrefactor</span> <span class="o">*</span> <span class="mf">6.66</span> <span class="o">*</span> <span class="p">(</span>
                                            <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">,</span> <span class="n">front_region</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;The tip elements are not in the band. Increase the size of the band for FMM to evaluate&quot;</span>
                             <span class="s2">&quot; level set.&quot;</span><span class="p">)</span>
        <span class="c1"># the search region outwards from the front position at last time step</span>
        <span class="n">pstv_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">front_region</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                                                                       <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">hy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># the search region inwards from the front position at last time step</span>
        <span class="n">ngtv_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">front_region</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># SOLVE EIKONAL eq via Fast Marching Method starting to get the distance from tip for each cell.</span>
        <span class="n">SolveFMM</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">,</span>
                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">,</span>
                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">,</span>
                 <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                 <span class="n">front_region</span><span class="p">[</span><span class="n">pstv_region</span><span class="p">],</span>
                 <span class="n">front_region</span><span class="p">[</span><span class="n">ngtv_region</span><span class="p">])</span>

        <span class="c1"># # if some elements remain unevaluated by fast marching method. It happens with unrealistic fracture geometry.</span>
        <span class="c1"># # todo: not satisfied with why this happens. need re-examining</span>
        <span class="c1"># if max(sgndDist_k) == 1e50:</span>
        <span class="c1">#     exitstatus = 2</span>
        <span class="c1">#     return exitstatus, None</span>

        <span class="c1"># do it only once if not anisotropic</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sim_properties</span><span class="o">.</span><span class="n">paramFromTip</span> <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">anisotropic_K1c</span>
                <span class="ow">or</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">TI_elasticity</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">explicitProjection</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">alpha_ribbon_k</span> <span class="o">-</span> <span class="n">alpha_ribbon_km1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">&lt;</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">toleranceProjection</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Projection iteration converged after &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">itr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; iterations; exiting norm &quot;</span> <span class="o">+</span>
                      <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>
            <span class="k">break</span>
        <span class="n">alpha_ribbon_km1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha_ribbon_k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iterating on projection... norm = &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">norm</span><span class="p">))</span>
        <span class="n">itr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1">#todo Hack!!! keep going if projection does not converge</span>
    <span class="c1"># if itr == sim_properties.maxToughnessItrs:</span>
    <span class="c1">#     exitstatus = 10</span>
    <span class="c1">#     return exitstatus, None</span>

    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">-</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">])</span> <span class="o">/</span> <span class="n">timeStep</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">sgndDist</span> <span class="o">=</span> <span class="n">sgndDist_k</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">sgndDist_last</span> <span class="o">=</span> <span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">sgndDist</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">timeStep_last</span> <span class="o">=</span> <span class="n">timeStep</span>
    <span class="n">new_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">[</span><span class="n">new_tip</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">new_tip</span><span class="p">]</span> <span class="o">/</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">new_tip</span><span class="p">]</span>

    <span class="c1"># setting leak off</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">LkOff_vol</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">Tarrival</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltChannel</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">EltArea</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">LkOff_vol</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mat_properties</span><span class="o">.</span><span class="n">Cprime</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">]</span> <span class="o">*</span> <span class="n">Integral_over_cell</span><span class="p">(</span>
                                                                    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">,</span>
                                                                    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                                                    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>
                                                                    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                    <span class="s1">&#39;Lk&#39;</span><span class="p">,</span>
                                                                    <span class="n">mat_prop</span><span class="o">=</span><span class="n">mat_properties</span><span class="p">,</span>
                                                                    <span class="n">frac</span><span class="o">=</span><span class="n">Fr_kplus1</span><span class="p">,</span>
                                                                    <span class="n">Vel</span><span class="o">=</span><span class="n">Vel_k</span><span class="p">,</span>
                                                                    <span class="n">dt</span><span class="o">=</span><span class="mf">1.e20</span><span class="p">,</span>
                                                                    <span class="n">arrival_t</span><span class="o">=</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">TarrvlZrVrtx</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltTip</span><span class="p">])</span>

    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">injectedVol</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Qin</span><span class="p">)</span> <span class="o">*</span> <span class="n">timeStep</span>
    <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">injectedVol</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">LkOff_vol</span><span class="p">[</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]))</span> \
                           <span class="o">/</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">injectedVol</span>

    <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveRegime</span><span class="p">:</span>
        <span class="n">regime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">,</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">regime</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_regime</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                    <span class="n">Fr_lstTmStp</span><span class="p">,</span>
                                                    <span class="n">mat_properties</span><span class="p">,</span>
                                                    <span class="n">sim_properties</span><span class="p">,</span>
                                                    <span class="n">timeStep</span><span class="p">,</span>
                                                    <span class="n">Kprime_k</span><span class="p">,</span>
                                                    <span class="o">-</span><span class="n">sgndDist_k</span><span class="p">[</span><span class="n">Fr_lstTmStp</span><span class="o">.</span><span class="n">EltRibbon</span><span class="p">])</span>
        <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">regime</span> <span class="o">=</span> <span class="n">regime</span>

    <span class="k">if</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">turbulence</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span><span class="p">:</span>
            <span class="n">ReNumb</span><span class="p">,</span> <span class="n">check</span> <span class="o">=</span> <span class="n">turbulence_check_tip</span><span class="p">(</span><span class="n">fluidVel</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="p">,</span> <span class="n">fluid_properties</span><span class="p">,</span> <span class="n">return_ReyNumb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span><span class="p">:</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">ReynoldsNumber</span> <span class="o">=</span> <span class="n">ReNumb</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span><span class="p">:</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidFlux</span> <span class="o">=</span> <span class="n">ReNumb</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">density</span> <span class="o">*</span> <span class="n">fluid_properties</span><span class="o">.</span><span class="n">viscosity</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidVel</span><span class="p">:</span>
            <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidVelocity</span> <span class="o">=</span> <span class="n">fluidVel</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidVel</span> <span class="ow">or</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span><span class="p">:</span>
            <span class="n">fluid_flux</span><span class="p">,</span> <span class="n">fluid_vel</span><span class="p">,</span> <span class="n">Rey_num</span> <span class="o">=</span> <span class="n">calculate_fluid_flow_characteristics_laminar</span><span class="p">(</span><span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">w</span><span class="p">,</span>
                                                                      <span class="n">C</span><span class="p">,</span>
                                                                      <span class="n">mat_properties</span><span class="o">.</span><span class="n">SigmaO</span><span class="p">,</span>
                                                                      <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span>
                                                                      <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">,</span>
                                                                      <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">InCrack</span><span class="p">,</span>
                                                                      <span class="n">fluid_properties</span><span class="o">.</span><span class="n">muPrime</span><span class="p">,</span>
                                                                      <span class="n">fluid_properties</span><span class="o">.</span><span class="n">density</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidFlux</span><span class="p">:</span>
                <span class="n">fflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">fflux</span><span class="p">[:,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluid_flux</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidFlux</span> <span class="o">=</span> <span class="n">fflux</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveFluidVel</span><span class="p">:</span>
                <span class="n">fvel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">fvel</span><span class="p">[:,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluid_vel</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">fluidVelocity</span> <span class="o">=</span> <span class="n">fvel</span>
            <span class="k">if</span> <span class="n">sim_properties</span><span class="o">.</span><span class="n">saveReynNumb</span><span class="p">:</span>
                <span class="n">Rnum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">NumberOfElts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">Rnum</span><span class="p">[:,</span> <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">EltCrack</span><span class="p">]</span> <span class="o">=</span> <span class="n">Rey_num</span>
                <span class="n">Fr_kplus1</span><span class="o">.</span><span class="n">ReynoldsNumber</span> <span class="o">=</span> <span class="n">Rnum</span>

    <span class="n">exitstatus</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">exitstatus</span><span class="p">,</span> <span class="n">Fr_kplus1</span></div>

</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">PyFrac 1.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Haseeb Zia.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>